---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

set: [pipefail]
shopt: [globstar]

vars:
  TEST: "test"

includes:
  sops: .taskfile/sops.yaml

tasks:
  default: task --list

  init: 
    desc: "集群中初始化内容（部署密钥/获取一些crd资源）"
    cmds:
      - task: deploy-secret
      - task: add-gateway-crd
      - task: add-external-dns-crd
      - cmd: |
          echo "手动运行下面命令获取azure的外部secret"
          echo "task deploy-azure-creds ClientID={} ClientSecret={}"
  
  bootstrap:
    desc: "k3s 部署"
    cmds:
      - cmd: |
          ansible-playbook {{.ROOT_DIR}}/ansible/site.yml
      - cmd: |
          ansible-playbook {{.ROOT_DIR}}/ansible/playbooks/send-files.yml
      - cmd: |
          echo "部署k3s server"
          k3sup install --user shelken --ip 192.168.6.80 \
          --k3s-extra-args "--disable traefik --disable servicelb --flannel-backend=none --disable-network-policy --disable-kube-proxy --embedded-registry --disable local-storage" \
          --k3s-version v1.33.1+k3s1 \
          --ssh-key ~/.ssh/id_ed25519
      - cmd: |
          echo "部署k3s worker"
          ips=("192.168.6.110" "192.168.6.111" "192.168.6.114")

          join() {
            k3sup join \
            --user shelken \
            --ip $1 \
            --server-ip 192.168.0.80 \
            --server-user shelken \
            --k3s-version v1.33.1+k3s1 \
            --ssh-key ~/.ssh/id_ed25519 &
          }
          # 遍历数组并异步执行命令
          for ip in "${ips[@]}"; do
            join $ip
          done

          wait
          echo "done"

  deploy-secret:
    desc: "部署sops加密的Secret让flux kustomization能够解密"
    cmd: |
      kubectl get namespace flux-system >/dev/null 2>&1 || kubectl create namespace flux-system
      sops exec-file "{{.ROOT_DIR}}/k8s/components/common/sops/secret.sops.yaml" "kubectl --namespace flux-system apply --server-side --filename {}"

  add-gateway-crd:
    desc: "添加gateway的CRD"
    cmd: |
      # renovate: datasource=github-releases depName=kubernetes-sigs/gateway-api
      kubectl apply -f https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.3.0/experimental-install.yaml --server-side
  
  # https://github.com/kubernetes-sigs/external-dns/blob/master/docs/sources/crd.md
  add-external-dns-crd:
    desc: "添加external-dns的CRD"
    cmd: |
      # renovate: datasource=github-releases depName=kubernetes-sigs/external-dns
      kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/external-dns/refs/tags/v0.18.0/config/crd/standard/dnsendpoints.externaldns.k8s.io.yaml --server-side

  show-route:
    desc: "显示gateway和对应的服务"
    silent: true
    cmd: |
      kubectl get httproutes --all-namespaces -o json | jq -r '
      .items[] |
      {
        namespace: .metadata.namespace,
        name: .metadata.name,
        gateways: (.spec.parentRefs // []) | map(.name) | join(","),
        hosts: (.spec.hostnames // []) | join(","),
        paths: (
          [.spec.rules[]?.matches[]?.path.value // empty] | unique | join(",")
        )
      } |
      "Gateways: \(.gateways)\t\(.namespace)/\(.name)\tHosts: \(.hosts)\tPaths: \(.paths)"
      '
      kubectl get -A ingress
  
  deploy-azure-creds:
    desc: "部署 azure 的验证信息让 external-secrets 访问我们的 KeyVault"
    silent: false
    preconditions:
      - '[ -n "$ClientID" ]'
      - '[ -n "$ClientSecret" ]'
    cmd: |
      kubectl get namespace external-secrets >/dev/null 2>&1 || kubectl create namespace external-secrets
      kubectl create secret -n external-secrets generic azure-creds \
      --from-literal=ClientID={{ .ClientID }} \
      --from-literal=ClientSecret={{ .ClientSecret }} --dry-run=client -o yaml \
      | kubectl apply -f -

  restart-cilium:
    desc: "restart-cilium"
    silent: false
    # preconditions:
    cmds:
      - |
        kubectl rollout restart deployment  -n kube-system cilium-operator && \
        kubectl rollout restart daemonset -n kube-system cilium && \
        kubectl rollout restart daemonset -n kube-system cilium-envoy

  relpath:
    desc: Calculate relative path from one file to another
    summary: ...
    dir: "{{ .ROOT_DIR }}"
    cmd: echo $(realpath --relative-to=$(dirname "{{ .start }}") "{{ .end }}")
    requires:
      vars: ["start"]
    vars:
      # start:
      end: '{{ .end | default "./k8s/components/common" }}'
    preconditions:
      - { msg: "Start file not found", sh: "test -f {{ .start }}" }
      - { msg: "End file not found", sh: "test -d {{ .end }}" }

  azsecret: 
    desc: 显示azure key vault的secret的value
    silent: true
    # requires:
    #   vars: ["name"]
    # vars:
    #   name: {{ .name }}
    cmd: |
      if [ -n "{{ .name }}" ]; then
        az keyvault secret show --vault-name shelken-vault --name "{{ .name }}" --query value -otsv
        exit 0
      fi
      az keyvault secret list --vault-name shelken-vault --query "[].name"