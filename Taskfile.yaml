---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

set: [pipefail]
shopt: [globstar]

vars:
  TEST: "test"

includes:
  sops: .taskfile/sops.yaml

tasks:
  default: task --list

  deploy-secret:
    desc: "部署sops加密的Secret让flux kustomization能够解密"
    cmds:
      - cmd: |
          kubectl get namespace flux-system >/dev/null 2>&1 || kubectl create namespace flux-system
          sops exec-file "{{.ROOT_DIR}}/k8s/components/common/sops/secret.sops.yaml" "kubectl --namespace flux-system apply --server-side --filename {}"
          sops exec-file "{{.ROOT_DIR}}/k8s/components/common/sops/cluster-secret.sops.yaml" "kubectl --namespace flux-system apply --server-side --filename {}"

  add-gateway-crd:
    desc: "添加gateway的CRD"
    cmds:
      - cmd: |
          # cilium 1.17.5 官方文档使用1.2.0的standard安装
          kubectl apply -f https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.2.0/standard-install.yaml --server-side
          kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/gateway-api/v1.2.0/config/crd/experimental/gateway.networking.k8s.io_tlsroutes.yaml
  add-external-dns-crd:
    desc: "添加external-dns的CRD"
    cmds:
      - cmd: |
          # https://github.com/kubernetes-sigs/external-dns/blob/master/docs/sources/crd.md
          # renovate: datasource=github-releases depName=kubernetes-sigs/external-dns
          kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/external-dns/refs/tags/v0.17.0/config/crd/standard/dnsendpoint.yaml --server-side

  show-route:
    desc: "显示gateway和对应的服务"
    silent: true
    cmds:
      - cmd: |
          kubectl get httproutes --all-namespaces -o json | jq -r '
          .items[] |
          {
            namespace: .metadata.namespace,
            name: .metadata.name,
            gateways: (.spec.parentRefs // []) | map(.name) | join(","),
            hosts: (.spec.hostnames // []) | join(","),
            paths: (
              [.spec.rules[]?.matches[]?.path.value // empty] | unique | join(",")
            )
          } |
          "Gateways: \(.gateways)\t\(.namespace)/\(.name)\tHosts: \(.hosts)\tPaths: \(.paths)"
          '
          kubectl get -A ingress
  deploy-azure-creds:
    desc: "部署 azure 的验证信息让 external-secrets 访问我们的 KeyVault"
    silent: false
    preconditions:
      - '[ -n "$ClientID" ]'
      - '[ -n "$ClientSecret" ]'
    cmds:
      - |
        kubectl get namespace external-secrets >/dev/null 2>&1 || kubectl create namespace external-secrets
        kubectl create secret -n external-secrets generic azure-creds \
        --from-literal=ClientID={{.ClientID}} \
        --from-literal=ClientSecret={{.ClientSecret}} --dry-run=client -o yaml \
        | kubectl apply -f -

  restart-cilium:
    desc: "restart-cilium"
    silent: false
    # preconditions:
    cmds:
      - |
        kubectl rollout restart deployment  -n kube-system cilium-operator && \
        kubectl rollout restart daemonset -n kube-system cilium && \
        kubectl rollout restart daemonset -n kube-system cilium-envoy

  relpath:
    desc: Calculate relative path from one file to another
    summary: ...
    dir: "{{ .ROOT_DIR }}"
    cmd: echo $(realpath --relative-to=$(dirname "{{ .start }}") "{{ .end }}")
    requires:
      vars: ["start"]
    vars:
      # start:
      end: '{{ .end | default "./k8s/components/common" }}'
    preconditions:
      - { msg: "Start file not found", sh: "test -f {{ .start }}" }
      - { msg: "End file not found", sh: "test -d {{ .end }}" }

  azsecret: 
    desc: 显示azure key vault的secret的value
    silent: true
    # requires:
    #   vars: ["name"]
    # vars:
    #   name: {{ .name }}
    cmd: |
      if [ -n "{{ .name }}" ]; then
        az keyvault secret show --vault-name shelken-vault --name "{{ .name }}" --query value -otsv
        exit 0
      fi
      az keyvault secret list --vault-name shelken-vault --query "[].name"