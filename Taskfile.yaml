---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

set: [pipefail]
shopt: [globstar]

vars:
  TEST: "test"

includes:
  sops: .taskfile/sops.yaml
  secret: .taskfile/secret.yaml
  flux: .taskfile/flux.yaml

tasks:
  default: task --list

  bootstrap:
    desc: "k3s 部署"
    cmds:
      - cmd: |
          echo "安装包，修改时区等系统设置调整"
          ansible-playbook {{.ROOT_DIR}}/ansible/site.yml
      - cmd: |
          echo "配置 k3s(containerd) 镜像mirror源 等"
          ansible-playbook {{.ROOT_DIR}}/ansible/playbooks/send-files.yml
      - cmd: |
          echo "部署k3s"
          ansible-playbook {{.ROOT_DIR}}/ansible/playbooks/install-k3s.yaml

  init-crd:
    desc: "初始化crd"
    cmd: |
      helmfile -f bootstrap/crds.yaml template -q | kubectl apply --server-side --field-manager bootstrap --force-conflicts -f -

  init:
    desc: "集群中初始化内容（部署密钥/获取一些crd资源）"
    cmds:
      - task: add-gateway-crd
      - task: add-external-dns-crd
      - task: add-prometheus-crd
      - task: secret:bootstrap
      - cmd: |
          helmfile --file bootstrap/helmfile.yaml sync --hide-notes
          # helmfile apply -f bootstrap/helmfile.yaml

  add-gateway-crd:
    desc: "添加gateway的CRD"
    cmd: |
      # renovate: datasource=github-releases depName=kubernetes-sigs/gateway-api
      kubectl apply -f https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.4.0/experimental-install.yaml --server-side

  # https://github.com/kubernetes-sigs/external-dns/blob/master/docs/sources/crd.md
  add-external-dns-crd:
    desc: "添加external-dns的CRD"
    cmd: |
      # renovate: datasource=github-releases depName=kubernetes-sigs/external-dns
      kubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/external-dns/refs/tags/v0.19.0/config/crd/standard/dnsendpoints.externaldns.k8s.io.yaml --server-side

  add-prometheus-crd:
    desc: "添加prometheus的CRD"
    cmd: |
      # renovate: datasource=github-releases depName=prometheus-operator/prometheus-operator
      kubectl apply -f https://github.com/prometheus-operator/prometheus-operator/releases/download/v0.86.1/stripped-down-crds.yaml --server-side

  show-route:
    desc: "显示gateway和对应的服务"
    silent: true
    cmd: |
      kubectl get httproutes --all-namespaces -o json | jq -r '
      .items[] |
      {
        namespace: .metadata.namespace,
        name: .metadata.name,
        gateways: (.spec.parentRefs // []) | map(.name) | join(","),
        hosts: (.spec.hostnames // []) | join(","),
        paths: (
          [.spec.rules[]?.matches[]?.path.value // empty] | unique | join(",")
        )
      } |
      "Gateways: \(.gateways)\t\(.namespace)/\(.name)\tHosts: \(.hosts)\tPaths: \(.paths)"
      '
      kubectl get -A ingress

  restart-cilium:
    desc: "restart-cilium"
    silent: false
    # preconditions:
    cmds:
      - |
        kubectl rollout restart deployment  -n kube-system cilium-operator && \
        kubectl rollout restart daemonset -n kube-system cilium && \
        kubectl rollout restart daemonset -n kube-system cilium-envoy && \
        kubectl rollout restart deployment -n kube-system coredns

  relpath:
    desc: Calculate relative path from one file to another
    summary: ...
    dir: "{{ .ROOT_DIR }}"
    cmd: echo $(realpath --relative-to=$(dirname "{{ .start }}") "{{ .end }}")
    requires:
      vars: ["start"]
    vars:
      # start:
      end: '{{ .end | default "./k8s/components/common" }}'
    preconditions:
      - { msg: "Start file not found", sh: "test -f {{ .start }}" }
      - { msg: "End file not found", sh: "test -d {{ .end }}" }

  # 将某个pvc（可选）挂载并起一个pod
  # pvc= kube-run
  kube-run:
    vars:
      image: '{{.image | default "busybox:latest"}}'
      pod: '{{.pod | default "test"}}'
      _node_default:
        sh: kubectl get nodes -l node-role.kubernetes.io/control-plane -o jsonpath='{.items[0].metadata.name}'
      node: "{{.node | default ._node_default}}"
      pvc: '{{.pvc | default ""}}'
      mount_path: '{{.mount_path | default "/data"}}'
    cmds:
      - |
        cat <<EOF | kubectl apply -f -
        apiVersion: v1
        kind: Pod
        metadata:
          name: {{.pod}}
        spec:
          nodeName: {{.node}}
          restartPolicy: Never
          containers:
          - name: {{.pod}}
            image: {{.image}}
            command: ["/bin/sh", "-c", "trap : TERM INT; sleep infinity & wait"]
            {{- if .pvc }}
            volumeMounts:
            - name: pvc-storage
              mountPath: "{{.mount_path}}"
            {{- end }}
          {{- if .pvc }}
          volumes:
          - name: pvc-storage
            persistentVolumeClaim:
              claimName: "{{.pvc}}"
          {{- end }}
        EOF
      - echo "Waiting for pod to be ready..."
      - kubectl wait --for=condition=Ready pod/{{.pod}} --timeout=60s
      - kubectl exec -it {{.pod}} -- /bin/sh
      - defer: kubectl delete pod {{.pod}} --ignore-not-found=true

  browse-pvc:
    requires:
      vars: ["namespace", "claim"]
    cmd: |
      kubectl browse-pvc -n {{ .namespace }} -i alpine:latest {{ .claim }}
    preconditions:
      - { msg: "need to install krew", sh: "which krew" }
      - {
          msg: "run install `krew install browse-pvc`",
          sh: "kubectl browse-pvc --help",
        }
