---
apiVersion: v1
kind: Service
metadata:
  name: upstream-nix-cache
spec:
  type: ExternalName
  # 将这个 service 的 DNS 名称指向真正的上游
  externalName: cache.nixos.org

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: nix-cache
  annotations:
    kubernetes.io/ingress.class: nginx-internal

    nginx.ingress.kubernetes.io/proxy-buffering: on

    nginx.ingress.kubernetes.io/configuration-snippet: |
      proxy_cache nix_cache_zone;

      proxy_cache_valid 200 302 60m;

      # 如果缓存未命中或过期，上游超时时间
      proxy_read_timeout 120s;
      proxy_connect_timeout 120s;

      # 将自定义的缓存头加上
      add_header Cache-Control $cache_header always;
      add_header X-Proxy-Cache $upstream_cache_status; # 添加一个头来调试缓存是否命中 (HIT, MISS, EXPIRED)

spec:
  rules:
  - host: "nix-cache.ooooo.space"
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: upstream-nix-cache
            port:
              number: 80
