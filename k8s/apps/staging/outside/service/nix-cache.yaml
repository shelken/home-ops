---
apiVersion: v1
kind: Service
metadata:
  name: upstream-nix-cache
spec:
  type: ExternalName
  # 将这个 service 的 DNS 名称指向真正的上游
  externalName: cache.nixos.org

---
# yaml-language-server: $schema=https://kubernetesjsonschema.dev/master-standalone/ingress.json
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: nix-cache
  annotations:
    # kubernetes.io/ingress.class: nginx-internal

    nginx.ingress.kubernetes.io/proxy-buffering: on

    nginx.ingress.kubernetes.io/server-snippet: |
      resolver 223.5.5.5 223.6.6.6 valid=300s ipv6=off;
      resolver_timeout 5s;

      # 定义共同的缓存和响应头处理
      location @handle_response {
        proxy_cache nix_cache_zone;
        proxy_cache_valid 200 302 60m;
        proxy_cache_use_stale error timeout;
        proxy_cache_lock on;

        add_header Cache-Control $cache_header always;
        add_header X-Proxy-Cache $upstream_cache_status always;
        add_header X-Proxy-From $upstream_source always;
      }

      # USTC镜像源作为主要源
      location @ustc {
        internal;
        set $upstream_source "mirrors.ustc.edu.cn";
        proxy_pass https://mirrors.ustc.edu.cn/nix-channels/store$request_uri;
        proxy_set_header Host $upstream_source;
        proxy_ssl_server_name on;

        # 镜像请求到Cachix
        mirror @cachix;
        mirror_request_body off;

        include @handle_response;
      }

      # Cachix源
      location @cachix {
        internal;
        set $upstream_source "nix-community.cachix.org";
        proxy_pass https://nix-community.cachix.org$request_uri;
        proxy_set_header Host $upstream_source;
        proxy_ssl_server_name on;

        # 镜像请求到Nixos官方源
        mirror @nixos;
        mirror_request_body off;

        include @handle_response;
      }

      # Nixos官方源
      location @nixos {
        internal;
        set $upstream_source "cache.nixos.org";
        proxy_pass https://cache.nixos.org$request_uri;
        proxy_set_header Host $upstream_source;
        proxy_ssl_server_name on;

        include @handle_response;
      }

    nginx.ingress.kubernetes.io/configuration-snippet: |
      try_files "" @ustc;

spec:
  ingressClassName: nginx-internal
  rules:
  - host: "nix-cache.ooooo.space"
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: upstream-nix-cache
            port:
              number: 443
