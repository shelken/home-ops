---
apiVersion: v1
kind: Service
metadata:
  name: upstream-nix-cache
spec:
  type: ExternalName
  # 将这个 service 的 DNS 名称指向真正的上游
  externalName: cache.nixos.org

---
# yaml-language-server: $schema=https://kubernetesjsonschema.dev/master-standalone/ingress.json
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: nix-cache
  annotations:
    # kubernetes.io/ingress.class: nginx-internal

    nginx.ingress.kubernetes.io/proxy-buffering: on

    nginx.ingress.kubernetes.io/server-snippet: |
      resolver 223.5.5.5 223.6.6.6 valid=300s ipv6=off;
      resolver_timeout 5s;

      location @proxy_handler {
        proxy_cache nix_cache_zone;
        proxy_cache_valid 200 302 60m;
        proxy_cache_use_stale error timeout;
        proxy_cache_lock on;

        proxy_intercept_errors on;
        # 关键配置：非200状态时尝试下一个上游
        proxy_next_upstream error timeout http_404 http_403 http_500 http_502 http_503 http_504;
        # proxy_next_upstream_tries 0;
        proxy_next_upstream_timeout 3s;

        proxy_pass $upstream_target;
        proxy_set_header Host $upstream_source;
        proxy_ssl_server_name on;

        add_header Cache-Control $cache_header always;
        add_header X-Proxy-Cache $upstream_cache_status always;
        add_header X-Proxy-From $upstream_source always;
      }

      # USTC镜像源
      location @ustc {
        set $upstream_source "mirrors.ustc.edu.cn";
        set $upstream_target "https://mirrors.ustc.edu.cn/nix-channels/store$request_uri";
        set $next_upstream "@cachix";
        try_files "" @proxy_handler;
      }

      # Cachix源
      location @cachix {
        set $upstream_source "nix-community.cachix.org";
        set $upstream_target "https://nix-community.cachix.org$request_uri";
        set $next_upstream "@nixos";
        try_files "" @proxy_handler;
      }

      # Nixos官方源
      location @nixos {
        set $upstream_source "cache.nixos.org";
        set $upstream_target "https://cache.nixos.org$request_uri";
        set $next_upstream "";
        try_files "" @proxy_handler;
      }

    nginx.ingress.kubernetes.io/configuration-snippet: |
      try_files "" @ustc;

spec:
  ingressClassName: nginx-internal
  rules:
  - host: "nix-cache.ooooo.space"
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: upstream-nix-cache
            port:
              number: 443
