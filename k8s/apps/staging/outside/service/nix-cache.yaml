---
apiVersion: v1
kind: Service
metadata:
  name: upstream-nix-cache
spec:
  type: ExternalName
  # 将这个 service 的 DNS 名称指向真正的上游
  externalName: cache.nixos.org

---
# yaml-language-server: $schema=https://kubernetesjsonschema.dev/master-standalone/ingress.json
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: nix-cache
  annotations:
    # kubernetes.io/ingress.class: nginx-internal

    nginx.ingress.kubernetes.io/proxy-buffering: on

    nginx.ingress.kubernetes.io/server-snippet: |
      location @ustc {
        set $upstream_source "mirrors.ustc.edu.cn";

        rewrite ^/(.*)$ /nix-channels/store/$1 break;
        proxy_pass https://mirrors.ustc.edu.cn;
        proxy_set_header Host "mirrors.ustc.edu.cn";
        # proxy_ssl_verify on;
        proxy_ssl_server_name on;
        
        error_page 404 = @cachix;
      }

      location @cachix {
        set $upstream_source "nix-community.cachix.org";
        proxy_pass https://nix-community.cachix.org;
        proxy_set_header Host "nix-community.cachix.org";
        # proxy_ssl_verify on;
        proxy_ssl_server_name on;

        error_page 404 = @nixos;
      }

      location @nixos {
        set $upstream_source "cache.nixos.org";
        proxy_pass https://cache.nixos.org;
        proxy_set_header Host "cache.nixos.org";
        # proxy_ssl_verify on;
        proxy_ssl_server_name on;
      }

    nginx.ingress.kubernetes.io/configuration-snippet: |
      try_files "" @ustc;

      proxy_cache nix_cache_zone;
      proxy_cache_valid 200 302 60m;
      proxy_cache_use_stale error timeout;
      proxy_cache_lock on;

      # 将自定义的缓存头加上
      add_header Cache-Control $cache_header always;
      add_header X-Proxy-Cache $upstream_cache_status; # 添加一个头来调试缓存是否命中 (HIT, MISS, EXPIRED)
      if ($upstream_cache_status = "MISS") {
        add_header X-Proxy-From $upstream_source always;
      }

spec:
  ingressClassName: nginx-internal
  rules:
  - host: "nix-cache.ooooo.space"
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: upstream-nix-cache
            port:
              number: 443
