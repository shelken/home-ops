---
# 为每个允许的域名创建 ExternalName Service
apiVersion: v1
kind: Service
metadata:
  name: proxy-github-com
spec:
  type: ExternalName
  externalName: github.com
  ports:
  - port: 443
    protocol: TCP

---
apiVersion: v1
kind: Service
metadata:
  name: proxy-raw-githubusercontent-com
spec:
  type: ExternalName
  externalName: raw.githubusercontent.com
  ports:
  - port: 443
    protocol: TCP

---
apiVersion: v1
kind: Service
metadata:
  name: exter-echo
spec:
  type: ExternalName
  externalName: echo.ooooo.space
  ports:
  - port: 443
    protocol: TCP

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: universal-proxy
  annotations:
    nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
    nginx.ingress.kubernetes.io/proxy-buffering: "on"
    nginx.ingress.kubernetes.io/proxy-buffer-size: "16k"
    nginx.ingress.kubernetes.io/proxy-buffers: "8 16k"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "30"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
    
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/rewrite-target: /$3
    
    # 请求限制配置
    nginx.ingress.kubernetes.io/configuration-snippet: |
      # 请求类型检查 - 只允许下载类请求
      if ($uri ~* "\.(html|htm|php|asp|aspx|jsp|jsf)$") {
          return 403 "Webpage requests are not allowed";
      }
      
      if ($http_accept ~* "text/html|application/xhtml\+xml|application/xml;q=0.9") {
          return 403 "Webpage content types are not allowed";
      }
      
      if ($uri ~* "^/($|index|home|main|default|web|www|portal)") {
          return 403 "Root and portal paths are not allowed";
      }
            
      # 设置代理头
      proxy_set_header Host "$1";
      proxy_set_header Accept "*/*";
      # proxy_set_header Referer "https://$1";
      proxy_set_header User-Agent "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/141.0.0.0 Safari/537.36";
      
      proxy_set_header X-Forwarded-For "";
      proxy_set_header X-Forwarded-Proto "";
      proxy_set_header X-Real-IP "";
      proxy_set_header X-Forwarded-Host "";
      # proxy_set_header X-Real-IP $remote_addr;
      # proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      # proxy_set_header X-Forwarded-Proto $scheme;
      # proxy_set_header X-Forwarded-Host $host;

      proxy_ssl_server_name on;
      proxy_ssl_name        "$1";
      

spec:
  ingressClassName: nginx-internal
  rules:
    - host: "proxy.${MAIN_DOMAIN}"
      http:
        paths:
          # GitHub 相关服务
          - path: /(github.com)(/|$)(.*)
            pathType: Prefix
            backend:
              service:
                name: proxy-github-com
                port:
                  number: 443
          - path: /(raw.githubusercontent.com)(/|$)(.*)
            pathType: Prefix
            backend:
              service:
                name: proxy-raw-githubusercontent-com
                port:
                  number: 443
          - path: /(echo.ooooo.space)(/|$)(.*)
            pathType: Prefix
            backend:
              service:
                name: exter-echo
                port:
                  number: 443