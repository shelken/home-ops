---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: immich
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: azure-store
  target:
    name: immich-secret
    template:
      data:
        # App
        # openssl rand -base64 128
        JWT_SECRET: "{{ .IMMICH_SECRET_KEY }}"
        # REDIS_PASSWORD: "{{ .DRAGONFLY_PASSWORD }}"
        # Database
        DB_HOSTNAME: &dbhost "immich-rw.database.svc.cluster.local"
        DB_PORT: "5432"
        DB_USERNAME: "postgres"
        DB_PASSWORD: "{{ .POSTGRES_SUPER_PASS }}"
        DB_DATABASE_NAME: &dbname "{{ .IMMICH_POSTGRES_DB }}"
        # Postgres Init
        INIT_POSTGRES_DBNAME: *dbname
        INIT_POSTGRES_HOST: *dbhost
        INIT_POSTGRES_USER: "{{ .IMMICH_POSTGRES_USER }}"
        INIT_POSTGRES_PASS: "{{ .IMMICH_POSTGRES_PASSWORD }}"
        INIT_POSTGRES_SUPER_PASS: "{{ .POSTGRES_SUPER_PASS }}"

        # immich.yaml(config file)
        # ref: https://docs.immich.app/install/config-file
        immich.yaml: |
          backup:
            database:
              cronExpression: 0 02 * * *
              enabled: false
              keepLastAmount: 14
          ffmpeg:
            # intel gpu
            accel: qsv
            accelDecode: true
            acceptedAudioCodecs:
              - aac
              - mp3
              - libopus
            acceptedContainers:
              - mov
              - ogg
              - webm
            acceptedVideoCodecs:
              - h264
            bframes: -1
            cqMode: auto
            crf: 23
            gopSize: 0
            maxBitrate: '0'
            preferredHwDevice: auto
            preset: ultrafast
            refs: 0
            targetAudioCodec: aac
            targetResolution: '720'
            targetVideoCodec: h264
            temporalAQ: false
            threads: 0
            tonemap: hable
            transcode: required
            twoPass: false
          image:
            colorspace: p3
            extractEmbedded: false
            fullsize:
              enabled: false
              format: jpeg
              quality: 80
            preview:
              format: jpeg
              quality: 80
              size: 1440
            thumbnail:
              format: webp
              quality: 80
              size: 250
          job:
            backgroundTask:
              concurrency: 5
            faceDetection:
              concurrency: 2
            library:
              concurrency: 5
            metadataExtraction:
              concurrency: 5
            migration:
              concurrency: 5
            notifications:
              concurrency: 5
            ocr:
              concurrency: 1
            search:
              concurrency: 5
            sidecar:
              concurrency: 5
            smartSearch:
              concurrency: 2
            thumbnailGeneration:
              concurrency: 3
            videoConversion:
              concurrency: 1
          library:
            scan:
              cronExpression: 15 * * * *
              enabled: true
            watch:
              enabled: false
          logging:
            enabled: true
            level: log
          machineLearning:
            availabilityChecks:
              enabled: true
              interval: 30000
              timeout: 2000
            clip:
              enabled: true
              modelName: ViT-B-16-SigLIP2__webli
            duplicateDetection:
              enabled: true
              maxDistance: 0.01
            enabled: true
            facialRecognition:
              enabled: true
              maxDistance: 0.5
              minFaces: 3
              minScore: 0.7
              modelName: buffalo_l
            ocr:
              enabled: true
              maxResolution: 736
              minDetectionScore: 0.5
              minRecognitionScore: 0.8
              modelName: PP-OCRv5_mobile
            urls:
              - http://immich-machine-learning.default.svc.cluster.local:3003
          map:
            darkStyle: https://tiles.immich.cloud/v1/style/dark.json
            enabled: true
            lightStyle: https://tiles.immich.cloud/v1/style/light.json
          metadata:
            faces:
              import: false
          newVersionCheck:
            enabled: false
          nightlyTasks:
            clusterNewFaces: true
            databaseCleanup: true
            generateMemories: true
            missingThumbnails: true
            startTime: 00:00
            syncQuotaUsage: true
          notifications:
            smtp:
              enabled: false
              from: ''
              replyTo: ''
              transport:
                host: ''
                ignoreCert: false
                password: ''
                port: 587
                secure: false
                username: ''
          oauth:
            autoLaunch: false
            autoRegister: false
            buttonText: Authelia 登录
            clientId: immich
            clientSecret: {{ .IMMICH_OAUTH_SECRET }}
            defaultStorageQuota: null
            enabled: true
            issuerUrl: https://auth.${MAIN_DOMAIN}/.well-known/openid-configuration
            mobileOverrideEnabled: false
            mobileRedirectUri: ''
            profileSigningAlgorithm: none
            roleClaim: user
            scope: openid email profile
            signingAlgorithm: RS256
            storageLabelClaim: preferred_username
            storageQuotaClaim: immich_quota
            timeout: 30000
            tokenEndpointAuthMethod: client_secret_post
          passwordLogin:
            enabled: true
          reverseGeocoding:
            enabled: true
          server:
            externalDomain: https://photo.${MAIN_DOMAIN}
            loginPageMessage: ''
            publicUsers: true
          templates:
            email:
              albumInviteTemplate: ''
              albumUpdateTemplate: ''
              welcomeTemplate: ''
          theme:
            customCss: ''
          trash:
            days: 30
            enabled: true
          user:
            deleteDelay: 7

  dataFrom:
    - extract:
        key: cloudnative-pg
    - extract:
        key: immich
