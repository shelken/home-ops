---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app karakeep
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: app-template
    namespace: flux-system
values:
  #ref: https://github.com/ahinko/home-ops/blob/main/kubernetes/apps/selfhosted/karakeep/app/helm-release.yaml
  #ref: https://github.com/ahgraber/homelab-gitops-k3s/blob/main/kubernetes/apps/default/karakeep/app/helmrelease.yaml
  defaultPodOptions:
    securityContext:
      runAsNonRoot: true
      runAsUser: 1000
      runAsGroup: 1000
      fsGroup: 1000
      fsGroupChangePolicy: "OnRootMismatch"

  controllers:
    karakeep:
      pod:
        annotations:
          reloader.stakater.com/auto: "true"
      containers:
        app:
          image:
            repository: ghcr.io/karakeep-app/karakeep
            tag: 0.28.0
          env:
            BROWSER_WEB_URL: http://karakeep-chrome.default.svc.cluster.local:9222
            COREPACK_INTEGRITY_KEYS: 0
            CRAWLER_DOWNLOAD_BANNER_IMAGE: true
            CRAWLER_ENABLE_ADBLOCKER: true
            CRAWLER_STORE_SCREENSHOT: true
            CRAWLER_FULL_PAGE_SCREENSHOT: true
            CRAWLER_ALLOWED_INTERNAL_HOSTNAMES: ".local"
            DATA_DIR: /data
            DISABLE_NEW_RELEASE_CHECK: true
            DISABLE_SIGNUPS: true
            MAX_ASSET_SIZE_MB: 128
            MEILI_ADDR: http://karakeep-meilisearch.default.svc.cluster.local:7700
            MEILI_MASTER_KEY:
              valueFrom:
                secretKeyRef:
                  name: karakeep-secret
                  key: meilisearch_master_key
            NEXTAUTH_SECRET:
              valueFrom:
                secretKeyRef:
                  name: karakeep-secret
                  key: encryption_key
            NEXTAUTH_URL: https://karakeep.${MAIN_DOMAIN}
            # OpenAI Config
            # ref：https://docs.karakeep.app/configuration/#inference-configs-for-automatic-tagging
            INFERENCE_LANG: chinese
            # OAuth
            OAUTH_WELLKNOWN_URL: https://auth.${MAIN_DOMAIN}/.well-known/openid-configuration
            OAUTH_CLIENT_SECRET:
              valueFrom:
                secretKeyRef:
                  name: karakeep-secret
                  key: OIDC_CLIENT_SECRET
            OAUTH_CLIENT_ID: karakeep
            OAUTH_PROVIDER_NAME: Authelia
            OAUTH_SCOPE: "openid profile email"
            OCR_LANGS: chi_sim,eng
          probes:
            liveness:
              enabled: true
            readiness:
              enabled: true
          resources:
            requests:
              cpu: 10m
            limits:
              memory: 1Gi

    chrome:
      pod:
        annotations:
          reloader.stakater.com/auto: "true"
      containers:
        app:
          image:
            repository: mirror.gcr.io/zenika/alpine-chrome
            tag: 124
          command:
            - chromium-browser
          args:
            - --headless
            - --no-sandbox
            - --disable-gpu
            - --disable-dev-shm-usage
            - --disable-background-timer-throttling
            - --remote-debugging-address=0.0.0.0
            - --remote-debugging-port=9222
            - --hide-scrollbars
          securityContext:
            capabilities:
              drop:
                - ALL
          resources:
            requests:
              cpu: 10m
            limits:
              memory: 1Gi

    meilisearch:
      pod:
        annotations:
          reloader.stakater.com/auto: "true"
        affinity:
          podAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              - labelSelector:
                  matchExpressions:
                    - key: app.kubernetes.io/name
                      operator: In
                      values:
                        - karakeep
                    - key: app.kubernetes.io/instance
                      operator: In
                      values:
                        - karakeep
                topologyKey: kubernetes.io/hostname
      containers:
        app:
          image:
            repository: mirror.gcr.io/getmeili/meilisearch
            tag: v1.26.0@sha256:773759814f59214a0971dc8810ae1d85002e92166d99760cd546d5ee8ac37c14
          args:
            - /bin/meilisearch
            - --experimental-dumpless-upgrade
          env:
            MEILI_NO_ANALYTICS: true
            MEILI_MASTER_KEY:
              valueFrom:
                secretKeyRef:
                  name: karakeep-secret
                  key: meilisearch_master_key
          resources:
            requests:
              cpu: 10m
            limits:
              memory: 4Gi

  service:
    app:
      primary: true
      controller: *app
      ports:
        http:
          port: &httpPort 3000
    chrome:
      controller: chrome
      ports:
        http:
          port: 9222
    meilisearch:
      controller: meilisearch
      ports:
        http:
          port: 7700

  persistence:
    data:
      existingClaim: karakeep
      advancedMounts:
        karakeep:
          app:
            - path: /data
              subPath: karakeep
            - path: /meili_data
              subPath: meilisearch
        meilisearch:
          app:
            - path: /meili_data
              subPath: meilisearch
    cache:
      type: emptyDir
      advancedMounts:
        karakeep:
          app:
            - path: /.cache
    appcache:
      type: emptyDir
      advancedMounts:
        karakeep:
          app:
            - path: /app/apps/web/.next/cache
  route:
    app:
      annotations:
        gethomepage.dev/enabled: "true"
        gethomepage.dev/description: 书签/稍后阅读/链接存档
        gethomepage.dev/group: 常用
        gethomepage.dev/icon: sh-karakeep.svg
        gethomepage.dev/name: Karakeep
        gethomepage.dev/app: karakeep
      hostnames:
        - karakeep.${MAIN_DOMAIN}
      parentRefs:
        - name: envoy-internal
          namespace: network
          sectionName: https
      rules:
        - backendRefs:
            - identifier: app
              port: *httpPort
