---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app seafile
spec:
  interval: 1h
  timeout: 15m
  chartRef:
    kind: OCIRepository
    name: app-template
    namespace: flux-system
  install:
    remediation:
      retries: -1
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  values:
    controllers:
      seafile:
        annotations:
          reloader.stakater.com/auto: "true"
        initContainers:
          init-db:
            image:
              repository: ghcr.io/linuxserver/mariadb
              tag: 10.11.10
            command:
              - sh
              - -c
              - |
                until mariadb -h"$INIT_DB_HOST" -uroot -p"$INIT_DB_ROOT_PASSWORD" -e "SELECT 1;" ; do
                  echo "Waiting for MariaDB..."
                  sleep 2
                done
                mariadb -h"$INIT_DB_HOST" -uroot -p"$INIT_DB_ROOT_PASSWORD" -e "CREATE DATABASE IF NOT EXISTS \`seafile_db\`;"
                mariadb -h"$INIT_DB_HOST" -uroot -p"$INIT_DB_ROOT_PASSWORD" -e "CREATE DATABASE IF NOT EXISTS \`ccnet_db\`;"
                mariadb -h"$INIT_DB_HOST" -uroot -p"$INIT_DB_ROOT_PASSWORD" -e "CREATE DATABASE IF NOT EXISTS \`seahub_db\`;"
                mariadb -h"$INIT_DB_HOST" -uroot -p"$INIT_DB_ROOT_PASSWORD" -e "CREATE USER IF NOT EXISTS '$INIT_DB_USER'@'%' IDENTIFIED BY '$INIT_DB_PASSWORD';"
                mariadb -h"$INIT_DB_HOST" -uroot -p"$INIT_DB_ROOT_PASSWORD" -e "GRANT ALL PRIVILEGES ON \`seafile_db\`.* TO '$INIT_DB_USER'@'%'; FLUSH PRIVILEGES;"
                mariadb -h"$INIT_DB_HOST" -uroot -p"$INIT_DB_ROOT_PASSWORD" -e "GRANT ALL PRIVILEGES ON \`ccnet_db\`.* TO '$INIT_DB_USER'@'%'; FLUSH PRIVILEGES;"
                mariadb -h"$INIT_DB_HOST" -uroot -p"$INIT_DB_ROOT_PASSWORD" -e "GRANT ALL PRIVILEGES ON \`seahub_db\`.* TO '$INIT_DB_USER'@'%'; FLUSH PRIVILEGES;"
            envFrom:
              - secretRef:
                  name: seafile-secret
        containers:
          app:
            image:
              repository: docker.io/seafileltd/seafile-pro-mc
              tag: 13.0.8
            #ref: https://github.com/haiwen/seafile-helm-chart/blob/main/values/13.0/pro.yaml
            env:
              TZ: ${TIMEZONE}
              TIME_ZONE: ${TIMEZONE}
              NON_ROOT: "false"
              SEAFILE_LOG_TO_STDOUT: "true"
              SEAFILE_SERVER_HOSTNAME: "seafile.${MAIN_DOMAIN}"
              SEAFILE_SERVER_PROTOCOL: "https"
              SEAF_SERVER_STORAGE_TYPE: "disk"
              
              # db
              SEAFILE_MYSQL_DB_HOST: "seafile-db.default.svc.cluster.local"
              SEAFILE_MYSQL_DB_PORT: "3306"
              SEAFILE_MYSQL_DB_USER: "seafile"
              SEAFILE_MYSQL_DB_CCNET_DB_NAME: "ccnet_db"
              SEAFILE_MYSQL_DB_SEAFILE_DB_NAME: "seafile_db"
              SEAFILE_MYSQL_DB_SEAHUB_DB_NAME: "seahub_db"

              # for cache
              CACHE_PROVIDER: "redis"
              REDIS_HOST: "dragonfly.database.svc.cluster.local"

              # other
              ENABLE_NOTIFICATION_SERVER: "false"
              ENABLE_SEADOC: "false"
              ENABLE_SEAFILE_AI: "false"
              MD_FILE_COUNT_LIMIT: "100000"
            envFrom:
              - secretRef:
                  name: seafile-secret
            probes:
              liveness: &probes
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /api2/ping/
                    port: &port 80
                  initialDelaySeconds: 120
                  periodSeconds: 10
                  timeoutSeconds: 1
                  failureThreshold: 30
              readiness: *probes
            # securityContext:
            #   allowPrivilegeEscalation: false
            #   readOnlyRootFilesystem: false
            #   capabilities: { drop: ["ALL"] }
            resources:
              requests:
                memory: 256Mi
              limits:
                memory: 4Gi
    defaultPodOptions:
      affinity: 
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: kubernetes.io/arch
                    operator: In
                    values:
                      - amd64
      securityContext:
        # runAsNonRoot: true
        # runAsUser: 1000
        # runAsGroup: 1000
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch
    service:
      app:
        ports:
          http:
            port: *port
    route:
      app:
        hostnames: ["{{ .Release.Name }}.${MAIN_DOMAIN}"]
        parentRefs:
          - name: external
            namespace: kube-system
            sectionName: https
    persistence:
      data:
        existingClaim: smb-sakamoto-storage
        globalMounts:
          - path: /shared
            subPath: seafile/data
      tmpfs:
        type: emptyDir
        advancedMounts:
          seafile:
            app:
              - path: /shared/logs
                subPath: logs