apiVersion: gateway.envoyproxy.io/v1alpha1
kind: EnvoyExtensionPolicy
metadata:
  name: geo-filter
spec:
  targetRefs:
    - name: envoy-external
      group: gateway.networking.k8s.io
      kind: Gateway
  wasm:
    - name: geo-filter
      failOpen: false
      rootID: geo-filter
      code:
        type: Image
        image:
          url: ghcr.io/corazawaf/coraza-proxy-wasm:0.6.0
      config:
        default_directives: default
        directives_map:
          default:
            [
              "SecDebugLogLevel 9",
              "SecRuleEngine On",
              "SecRequestBodyAccess On",
              "SecAuditEngine On",
              "SecAuditLogFormat JSON",
              "SecAuditLogType Serial",
              "SecAuditLog /dev/stdout",
              "SecAuditLogParts ABCEFGHIJKZ",
              "SecGeoLookupDb /etc/envoy/geoip/GeoLite2-City.mmdb",
              'SecRule REMOTE_ADDR ".*" "id:9001,phase:1,pass,log,msg:''Coraza DEBUG: Client IP is %{REMOTE_ADDR}''"',
              'SecRule REMOTE_ADDR "@geoLookup" "id:100,phase:1,nolog,pass"',
              'SecRule GEO:REGION "!@streq GD" "id:101,phase:1,deny,status:403,msg:''Blocked: Non-GD Region (%{GEO:REGION})''"',
            ]
