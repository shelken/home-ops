apiVersion: gateway.envoyproxy.io/v1alpha1
kind: EnvoyPatchPolicy
metadata:
  name: geo-filter
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: Gateway
    name: envoy-gateway # 你的 Gateway 名称
  type: JSONPatch
  jsonPatches:
    - type: "type.googleapis.com/envoy.config.listener.v3.Listener"
      # 这里的过滤器通常放在 HTTP Connection Manager 的 http_filters 列表中
      # 下面的 patch 意为：找到 HCM 配置，在过滤器列表顶部插入 GeoIP 过滤器
      operation: add
      path: "/default_filter_chain/filters/0/typed_config/http_filters/0"
      value:
        name: envoy.filters.http.geoip
        typed_config:
          "@type": "type.googleapis.com/envoy.extensions.filters.http.geoip.v3.Geoip"
          geo_headers_to_add:
            country: "x-geo-country"
            city: "x-geo-city"
            region: "x-geo-region"
          provider:
            name: "envoy.geoip_providers.maxmind"
            typed_config:
              "@type": "type.googleapis.com/envoy.extensions.geoip_providers.maxmind.v3.MaxMindConfig"
              common_provider_config:
                geo_headers_to_add:
                  country: "x-geo-country"
                  city: "x-geo-city"
              database_file: "/etc/envoy/geoip/GeoLite2-City.mmdb"
