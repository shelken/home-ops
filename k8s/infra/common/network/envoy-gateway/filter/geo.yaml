apiVersion: gateway.envoyproxy.io/v1alpha1
kind: EnvoyPatchPolicy
metadata:
  name: geo-filter
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: Gateway
    name: envoy-external
  type: JSONPatch
  jsonPatches:
    - type: "type.googleapis.com/envoy.config.listener.v3.Listener"
      name: "network/envoy-external/https"
      operation: &op1
        op: add
        path: "/filter_chains/0/filters/0/typed_config/http_filters/0"
        value:
          name: envoy.filters.http.geoip
          typed_config:
            "@type": "type.googleapis.com/envoy.extensions.filters.http.geoip.v3.Geoip"
            # ❌ 移除顶层的 geo_headers_to_add
            provider:
              name: "envoy.geoip_providers.maxmind"
              typed_config:
                "@type": "type.googleapis.com/envoy.extensions.geoip_providers.maxmind.v3.MaxMindConfig"
                # ✅ 只在 common_provider_config 中配置
                common_provider_config:
                  geo_headers_to_add:
                    country: "x-geo-country"
                    city: "x-geo-city"
                    region: "x-geo-region"
                    asn: "x-geo-asn"
                city_db_path: "/etc/envoy/geoip/GeoLite2-City.mmdb"
                asn_db_path: "/etc/envoy/geoip/GeoLite2-ASN.mmdb"
    - type: type.googleapis.com/envoy.config.listener.v3.Listener
      name: network/envoy-external/https-quic
      operation: *op1
    # 2. 添加 RBAC filter 进行地理位置访问控制
    - type: "type.googleapis.com/envoy.config.listener.v3.Listener"
      name: "network/envoy-external/https"
      operation: &op2
        op: add
        path: "/filter_chains/0/filters/0/typed_config/http_filters/1"
        value:
          name: envoy.filters.http.rbac
          typed_config:
            "@type": "type.googleapis.com/envoy.extensions.filters.http.rbac.v3.RBAC"
            rules:
              action: ALLOW
              policies:
                allow-specific-domains:
                  # 特定域名不限制地理位置
                  permissions: [{any: true}]
                  principals:
                    - or_ids:
                        ids:
                          - header: {name: ":authority", string_match: {exact: "flux-webhook.${MAIN_DOMAIN}"}}
                          - remote_ip: {address_prefix: "${MAIN_VPS_IP}", prefix_len: 32}
                          - remote_ip: {address_prefix: "${MAIN_VPS_IP_V6}", prefix_len: 128}
                          # - header: {name: ":authority", string_match: {suffix: ".suffix.example.com"}}
                # allow-private-networks:
                #   permissions: [{any: true}]
                #   principals:
                #     - or_ids:
                #         ids:
                #           - remote_ip: {address_prefix: "192.168.0.0", prefix_len: 16}
                #           - remote_ip: {address_prefix: "10.0.0.0", prefix_len: 8}
                #           - remote_ip: {address_prefix: "172.16.0.0", prefix_len: 12}
                #           - remote_ip: {address_prefix: "127.0.0.0", prefix_len: 8}
                # unknown 包含内网情况
                allow-unknown-location:
                  permissions: [{any: true}]
                  principals:
                    - not_id:
                        header:
                          name: "x-geo-country"
                          present_match: true
                geo-allowlist:
                  permissions: [{any: true}]
                  principals:
                    - or_ids:
                        ids:
                          # asn
                          # - header: {name: "x-geo-asn", string_match: {exact: "35916"}}
                          # 城市级别控制
                          - and_ids: {ids: [{header: {name: "x-geo-country", string_match: {exact: "CN"}}}, {header: {name: "x-geo-city", string_match: {exact: "Shenzhen"}}}]}
                          # - and_ids: {ids: [{header: {name: "x-geo-country", string_match: {exact: "US"}}}, {header: {name: "x-geo-city", string_match: {exact: "Los Angeles"}}}]}
                          # 国家/地区 级别控制
                          - header: {name: "x-geo-country", string_match: {exact: "CN"}} # maxmind国内v6太差
                          - header: {name: "x-geo-country", string_match: {exact: "HK"}}
                          # 省级别
                          - and_ids: {ids: [{header: {name: "x-geo-country", string_match: {exact: "CN"}}}, {header: {name: "x-geo-region", string_match: {exact: "GD"}}}]}
    - type: type.googleapis.com/envoy.config.listener.v3.Listener
      name: network/envoy-external/https-quic
      operation: *op2
    # 3. 添加 Local Reply 配置来自定义 RBAC 拒绝响应
    - type: "type.googleapis.com/envoy.config.listener.v3.Listener"
      name: "network/envoy-external/https"
      operation: &op3
        op: add
        path: "/filter_chains/0/filters/0/typed_config/local_reply_config"
        value:
          mappers:
            - filter:
                # 使用 and_filter 组合两个条件
                and_filter:
                  filters:
                    # 条件1: 状态码必须是 403
                    - status_code_filter:
                        comparison:
                          op: EQ
                          value:
                            default_value: 403
                            runtime_key: unused_key
                    # 条件2: 必须包含 x-geo-country 头部 (证明已经经过了 GeoIP 处理)
                    - header_filter:
                        header:
                          name: "x-geo-country"
                          present_match: true
              body_format_override:
                text_format_source:
                  inline_string: |
                    {
                      "error": "Access Denied - Geographic Restriction",
                      "message": "Your location is not allowed to access this service",
                      "your_location": {
                        "country": "%REQ(x-geo-country)%",
                        "region": "%REQ(x-geo-region)%",
                        "city": "%REQ(x-geo-city)%"
                      },
                      "client_ip": "%DOWNSTREAM_REMOTE_ADDRESS_WITHOUT_PORT%",
                      "timestamp": "%START_TIME%",
                      "request_id": "%REQ(x-request-id)%"
                    }
                content_type: "application/json"
    - type: type.googleapis.com/envoy.config.listener.v3.Listener
      name: network/envoy-external/https-quic
      operation: *op3
