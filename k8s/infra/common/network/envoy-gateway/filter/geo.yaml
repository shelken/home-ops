apiVersion: gateway.envoyproxy.io/v1alpha1
kind: EnvoyPatchPolicy
metadata:
  name: geo-filter
spec:
  targetRef:
    group: gateway.networking.k8s.io
    kind: Gateway
    name: envoy-gateway # 你的 Gateway 名称
  type: JSONPatch
  jsonPatches:
    - type: "type.googleapis.com/envoy.config.listener.v3.Listener"
      # 【关键修复】必须给这个 patch 起一个名字，否则校验失败
      name: "inject-geoip-http-filter"
      # 之前的修复：operation 必须是对象
      operation:
        op: "add"
        path: "/default_filter_chain/filters/0/typed_config/http_filters/0"
        value:
          name: envoy.filters.http.geoip
          typed_config:
            "@type": "type.googleapis.com/envoy.extensions.filters.http.geoip.v3.Geoip"
            geo_headers_to_add:
              country: "x-geo-country"
              city: "x-geo-city"
              region: "x-geo-region"
            provider:
              name: "envoy.geoip_providers.maxmind"
              typed_config:
                "@type": "type.googleapis.com/envoy.extensions.geoip_providers.maxmind.v3.MaxMindConfig"
                common_provider_config:
                  geo_headers_to_add:
                    country: "x-geo-country"
                    city: "x-geo-city"
                # 再次提醒：确保这个路径与 EnvoyProxy 挂载的路径完全一致
                database_file: "/etc/envoy/geoip/GeoLite2-City.mmdb"
