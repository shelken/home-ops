# yaml-language-server: $schema=https://raw.githubusercontent.com/yannh/kubernetes-json-schema/refs/heads/master/v1.34.1/service-v1.json
apiVersion: v1
kind: Service
metadata:
  annotations:
    tailscale.com/tailnet-ip: "100.97.0.8"
    tailscale.com/proxy-class: ts-node-vps
  name: ts-node-vps
spec:
  externalName: unused
  type: ExternalName
  ports:
    - port: 9100
      protocol: TCP
      name: node-export
    - port: 2575
      protocol: TCP
      name: docker-proxy
    - port: 2019
      protocol: TCP
      name: caddy-metrics
    - port: 443
      protocol: TCP
      name: caddy

---
apiVersion: tailscale.com/v1alpha1
kind: ProxyClass
metadata:
  name: ts-node-vps
spec:
  tailscale:
    acceptRoutes: true
  statefulSet:
    pod:
      labels:
        app.ooooo.space/need-ipv6: "true"
        app.ooooo.space/multus: "true"
      annotations:
        k8s.v1.cni.cncf.io/networks: |
          [{
            "name": "multus-tailscale",
            "namespace": "network",
            "interface": "eth1",
            "ips": ["192.168.6.66/32"],
            "mac": "02:2E:5F:AE:6A:66"
          }]
      securityContext:
        sysctls:
          - name: net.ipv6.conf.eth1.accept_ra
            value: "2"
      tailscaleContainer: &c
        resources:
          limits:
            squat.ai/tun: "1"
        env:
          - name: PORT
            value: "44555"
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - ALL
            add:
              - NET_ADMIN
