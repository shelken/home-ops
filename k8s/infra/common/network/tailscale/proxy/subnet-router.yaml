---
apiVersion: tailscale.com/v1alpha1
kind: Connector
metadata:
  name: ts-router
spec:
  #ref: https://github.com/tailscale/tailscale/blob/main/k8s-operator/api.md#connectorspec
  hostname: k8s-router
  proxyClass: k8s-router
  replicas: 1
  exitNode: true
  subnetRouter:
    advertiseRoutes:
      - "192.168.6.0/24"
      - "192.168.10.0/24"
      - "192.168.69.0/24"
      # - "10.43.0.0/16"
      # - "10.42.0.0/16"

---
apiVersion: tailscale.com/v1alpha1
kind: ProxyClass
metadata:
  name: k8s-router
spec:
  # ref: https://github.com/tailscale/tailscale/blob/main/k8s-operator/api.md#proxyclassspec
  tailscale:
    acceptRoutes: true
  statefulSet:
    labels:
      app.ooooo.space/need-ipv6: "true"
      app.ooooo.space/multus: "true"
    pod:
      annotations:
        k8s.v1.cni.cncf.io/networks: |
          [{
            "name": "multus-ipv6",
            "namespace": "network",
            "interface": "eth1",
            "ips": ["192.168.70.65/24"],
            "mac": "02:2E:5F:AE:6A:65"
          }]
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100  # 必须指定权重 (1-100)
              preference:  # 必须包含 preference 字段
                matchExpressions:
                  - key: kubernetes.io/hostname
                    operator: NotIn
                    values:
                      - sakamoto-k8s
      securityContext:
        sysctls:
          - name: net.ipv6.conf.eth1.accept_ra
            value: "2"
      tailscaleContainer: &c
        resources:
          limits:
            squat.ai/tun: "1"
        env:
          - name: PORT
            value: "44555"
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - ALL
            add:
              - NET_ADMIN
