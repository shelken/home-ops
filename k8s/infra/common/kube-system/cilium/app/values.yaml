# 配置：https://docs.cilium.io/en/latest/helm-reference
# ref：https://github.com/cilium/cilium/blob/v1.17.5/install/kubernetes/cilium/values.yaml
# gateway-api: https://docs.cilium.io/en/stable/network/servicemesh/gateway-api/gateway-api
ipv6:
  enabled: false

ipam:
  mode: kubernetes
  operator:
    clusterPoolIPv4PodCIDRList: ["10.42.0.0/16"]

k8sServiceHost: 127.0.0.1
k8sServicePort: 6444        # k3s
l2announcements:
  enabled: true

kubeProxyReplacement: true

cgroup:
  automount:
    enabled: false
  hostRoot: /sys/fs/cgroup

prometheus:
  enabled: true
  serviceMonitor:
    enabled: true
    trustCRDsExist: true

dashboards:
      enabled: true

envoy:
  rollOutPods: true
  prometheus:
    serviceMonitor:
      enabled: true

operator:
  # replicas: 2
  rollOutPods: true
  prometheus:
    enabled: true
    serviceMonitor:
      enabled: true
  dashboards:
      enabled: true

gatewayAPI:
  enabled: true
  enableAlpn: true # grpc support https://github.com/bittrance/cilium/blob/d6f7acf1116e74ce493c87a8f5df96efac63df7b/Documentation/network/servicemesh/gateway-api/grpc.rst
  # xffNumTrustedHops: 1 # X-Forwarded-For 头

# ingressController:
#   enabled: true
#   default: true
#   loadbalancerMode: shared

hubble:
  enabled: true
  metrics:
    enabled:
      - dns:query
      - drop
      - tcp
      - flow
      - port-distribution
      - icmp
      - http
    serviceMonitor:
      enabled: true
    dashboards:
      enabled: true
  relay:
    enabled: true
    rollOutPods: true
    prometheus:
      serviceMonitor:
        enabled: true
  ui:
    enabled: true
    rollOutPods: true

# !!!不要随便加下面，问题多
# securityContext:
#   capabilities:
#     ciliumAgent:
#       - CHOWN
#       - KILL
#       - NET_ADMIN
#       - NET_RAW
#       - IPC_LOCK
#       - SYS_ADMIN
#       - SYS_RESOURCE
#       - PERFMON
#       - BPF
#       - DAC_OVERRIDE
#       - FOWNER
#       - SETGID
#       - SETUID
#     cleanCiliumState:
#       - NET_ADMIN
#       - SYS_ADMIN
#       - SYS_RESOURCE

rollOutCiliumPods: true
# localRedirectPolicy: true
bpf:
  masquerade: true
  # hostLegacyRouting: true
  # tproxy: true

# 在所有节点都在同一个l2网段时可以启用
# https://docs.cilium.io/en/stable/network/concepts/routing/
autoDirectNodeRoutes: true
routingMode: native
ipv4NativeRoutingCIDR: "10.42.0.0/16"
devices: lima1 eth+

loadBalancer:
  algorithm: maglev
  mode: dsr

endpointRoutes:
  enabled: true

socketLB:
  hostNamespaceOnly: true # for tailscale ref: https://tailscale.com/kb/1236/kubernetes-operator#cilium-in-kube-proxy-replacement-mode

# enableIPv4BIGTCP: true # Linux 5.19+

# for multus
cni:
  exclusive: false