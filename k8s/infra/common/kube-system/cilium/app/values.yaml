# 配置：https://docs.cilium.io/en/latest/helm-reference
# ref：https://github.com/cilium/cilium/blob/v1.18.3/install/kubernetes/cilium/values.yaml
ipv6:
  enabled: false
# enableIPv6Masquerade: true
# ipv6NativeRoutingCIDR: "fd80:dead:42::/56"

bandwidthManager:
  enabled: true
  bbr: true

# ref: https://docs.cilium.io/en/stable/network/concepts/ipam/
ipam:
  mode: kubernetes
  operator:
    clusterPoolIPv4PodCIDRList: ["10.42.0.0/16"]
    clusterPoolIPv6PodCIDRList: ["fd80:dead:42::/56"]

k8sServiceHost: 127.0.0.1
k8sServicePort: 6444 # k3s
l2announcements:
  enabled: true

kubeProxyReplacement: true

cgroup:
  automount:
    enabled: false
  hostRoot: /sys/fs/cgroup

prometheus:
  enabled: true
  serviceMonitor:
    enabled: true
    trustCRDsExist: true

dashboards:
  enabled: true

envoy:
  enabled: false

operator:
  replicas: 1
  rollOutPods: true
  prometheus:
    enabled: true
    serviceMonitor:
      enabled: true
  dashboards:
    enabled: true

# ingressController:
#   enabled: true
#   default: true
#   loadbalancerMode: shared

# !!!不要随便加下面，问题多
# securityContext:
#   capabilities:
#     ciliumAgent:
#       - CHOWN
#       - KILL
#       - NET_ADMIN
#       - NET_RAW
#       - IPC_LOCK
#       - SYS_ADMIN
#       - SYS_RESOURCE
#       - PERFMON
#       - BPF
#       - DAC_OVERRIDE
#       - FOWNER
#       - SETGID
#       - SETUID
#     cleanCiliumState:
#       - NET_ADMIN
#       - SYS_ADMIN
#       - SYS_RESOURCE

rollOutCiliumPods: true
# localRedirectPolicy: true
bpf:
  masquerade: true
  # 6.8+
  # datapathMode: netkit
  # hostLegacyRouting: true
  # tproxy: true
bpfClockProbe: true

# 在所有节点都在同一个l2网段时可以启用
# https://docs.cilium.io/en/stable/network/concepts/routing/
autoDirectNodeRoutes: true
routingMode: native
ipv4NativeRoutingCIDR: "10.42.0.0/16"
devices: lima1 eth+

loadBalancer:
  algorithm: maglev
  mode: dsr

endpointRoutes:
  enabled: true

socketLB:
  hostNamespaceOnly: true # for tailscale ref: https://tailscale.com/kb/1236/kubernetes-operator#cilium-in-kube-proxy-replacement-mode

# enableIPv4BIGTCP: true # Linux 5.19+

# for multus
cni:
  exclusive: false
