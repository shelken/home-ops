# 配置：https://docs.cilium.io/en/latest/helm-reference
# ref：https://github.com/cilium/cilium/blob/v1.18.3/install/kubernetes/cilium/values.yaml

# 在所有节点都在同一个l2网段时可以启用
# https://docs.cilium.io/en/stable/network/concepts/routing/
autoDirectNodeRoutes: true

bandwidthManager:
  enabled: true
  bbr: true

bgpControlPlane:
  enabled: true

bpf:
  masquerade: true
  # 6.7+
  datapathMode: netkit
  # hostLegacyRouting: true
  # tproxy: true

bpfClockProbe: true

cgroup:
  automount:
    enabled: false
  hostRoot: /sys/fs/cgroup

cni:
  # for multus
  exclusive: false

dashboards:
  enabled: true

devices: lima1 eth+

endpointRoutes:
  enabled: true

envoy:
  enabled: false

enableIPv4BIGTCP: true # Linux 5.19+

# enableIPv6Masquerade: true
# ipv6NativeRoutingCIDR: "fd80:dead:42::/56"

ipv4NativeRoutingCIDR: "10.42.0.0/16"
ipv6:
  enabled: false

# ref: https://docs.cilium.io/en/stable/network/concepts/ipam/
ipam:
  mode: kubernetes
  operator:
    clusterPoolIPv4PodCIDRList: ["10.42.0.0/16"]
    clusterPoolIPv6PodCIDRList: ["fd80:dead:42::/56"]

k8sServiceHost: 127.0.0.1
k8sServicePort: 6444 # k3s

kubeProxyReplacement: true

l2announcements:
  enabled: false

loadBalancer:
  algorithm: maglev
  mode: dsr

localRedirectPolicies:
  enabled: true

operator:
  replicas: 1
  rollOutPods: true
  prometheus:
    enabled: true
    serviceMonitor:
      enabled: true
  dashboards:
    enabled: true

prometheus:
  enabled: true
  serviceMonitor:
    enabled: true
    trustCRDsExist: true

rollOutCiliumPods: true

routingMode: native

# !!!不要随便加下面，问题多
# securityContext:
#   capabilities:
#     ciliumAgent:
#       - CHOWN
#       - KILL
#       - NET_ADMIN
#       - NET_RAW
#       - IPC_LOCK
#       - SYS_ADMIN
#       - SYS_RESOURCE
#       - PERFMON
#       - BPF
#       - DAC_OVERRIDE
#       - FOWNER
#       - SETGID
#       - SETUID
#     cleanCiliumState:
#       - NET_ADMIN
#       - SYS_ADMIN
#       - SYS_RESOURCE

socketLB:
  enabled: true
  hostNamespaceOnly: true # for tailscale ref: https://tailscale.com/kb/1236/kubernetes-operator#cilium-in-kube-proxy-replacement-mode
