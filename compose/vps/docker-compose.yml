services:
  mosdns:
    image: ghcr.io/shelken/mosdns:vps-latest
    container_name: mosdns
    networks:
      - homelab
    restart: always
    labels:
      - homepage.group=VPS
      - homepage.name=mosdns
      - homepage.icon=azure-dns.svg
      - homepage.description=dns服务
    environment:
      TZ: Asia/Shanghai
      REMOTE_DNS_SERVER_1: ${REMOTE_DNS_SERVER_1}
      REMOTE_DNS_SERVER_2: ${REMOTE_DNS_SERVER_2}
    ports:
      - "5054:53"
      - "5054:53/udp"
    deploy:
      replicas: 1
    logging:
      options:
        max-size: "80m"
        max-file: "3"

  node-exporter:
    container_name: node-exporter
    command:
      - "--path.rootfs=/host/root"
      - "--path.procfs=/host/proc"
      - "--path.sysfs=/host/sys"
      - "--path.udev.data=/host/root/run/udev/data"
      - "--web.listen-address=0.0.0.0:9100"
      - >-
        --collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)
    image: prom/node-exporter:v1.10.2
    labels:
      - homepage.group=VPS
      - homepage.name=node-exporter
      - homepage.icon=docker-moby.svg
      - homepage.description=
    networks:
      - homelab
    restart: always
    ports:
      - "${DEPLOY_HOST}:9100:9100/tcp"
    volumes:
      - /:/host/root:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
    deploy:
      replicas: 1

  caddy:
    image: ghcr.io/shelken/caddy:rolling
    container_name: caddy
    networks:
      - homelab
    restart: always
    labels:
      - homepage.group=VPS
      - homepage.name=vps-caddy
      - homepage.icon=caddy.svg
      - homepage.description=vps反向代理
      - homepage.href=https://victoria-logs.${MAIN_DOMAIN}/select/vmui/#/?query=%7Bapp%3D%22caddy-vps-cc%22%7D
      - homepage.widget.type=caddy
      - homepage.widget.url=http://ts-node-vps.network.svc:2019
    environment:
      TZ: Asia/Shanghai
      MAIN_DOMAIN: ${MAIN_DOMAIN}
      CLOUDFLARE_API_TOKEN: ${CADDY_CLOUDFLARE_API_TOKEN}
      CROWDSEC_LOCAL_API_URL: ${CROWDSEC_LOCAL_API_URL}
      CROWDSEC_CADDY_BOUNCER_API_KEY: ${CROWDSEC_CADDY_BOUNCER_API_KEY}
      ENVOY_EXTERNAL_IP: ${ENVOY_EXTERNAL_IP}
    configs:
      - source: caddy_config
        target: /etc/caddy/Caddyfile
    volumes:
      - "${DATA_BASE_DIR}/caddy/site:/srv"
      - "${DATA_BASE_DIR}/caddy/data:/data"
      - "${DATA_BASE_DIR}/caddy/config:/config"
      - /var/log/caddy:/var/log/caddy
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
      - "${DEPLOY_HOST}:2019:2019/tcp"
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    deploy:
      replicas: 1

  crowdsec-agent:
    image: ghcr.io/crowdsecurity/crowdsec:v1.7.6
    container_name: crowdsec-agent
    networks:
      - homelab
    restart: always
    labels:
      - homepage.group=VPS
      - homepage.name=crowdsec
      - homepage.icon=crowdsec.svg
      - homepage.description=安全检测
      - homepage.href=https://grafana.${MAIN_DOMAIN}/d/crowdsec-threat-intel/crowdsec-threat-intelligence?from=now-24h&to=now
    environment:
      COLLECTIONS: |-
        crowdsecurity/linux
        crowdsecurity/caddy
        crowdsecurity/http-cve
        crowdsecurity/appsec-virtual-patching
        crowdsecurity/appsec-generic-rules
        crowdsecurity/appsec-crs
      DISABLE_LOCAL_API: "true"
      LOCAL_API_URL: ${CROWDSEC_LOCAL_API_URL}
      AGENT_USERNAME: vps-cc
      AGENT_PASSWORD: ${CROWDSEC_AGENT_PASSWORD}
      CROWDSEC_BYPASS_DB_VOLUME_CHECK: "true"
    configs:
      - source: crowdsec_acquis_all
        target: /etc/crowdsec/acquis.d/all.yaml
    volumes:
      - /var/log:/var/log:ro
    deploy:
      replicas: 1

  crowdsec-firewall-bouncer:
    image: ghcr.io/shgew/cs-firewall-bouncer-docker:v0.0.34
    container_name: crowdsec-firewall-bouncer
    network_mode: host
    restart: always
    labels:
      - homepage.group=VPS
      - homepage.name=firewall-bouncer
      - homepage.icon=crowdsec.svg
      - homepage.description=防火墙封禁
    cap_add:
      - NET_ADMIN
      - NET_RAW
    security_opt:
      - no-new-privileges:true
    environment:
      TZ: Asia/Shanghai
      CROWDSEC_LOCAL_API_URL: ${CROWDSEC_LOCAL_API_URL}
      CROWDSEC_FIREWALL_BOUNCER_API_KEY: ${CROWDSEC_FIREWALL_BOUNCER_API_KEY}
    configs:
      - source: crowdsec_firewall_bouncer_config
        target: /config/crowdsec-firewall-bouncer.yaml
    volumes:
      - /etc/localtime:/etc/localtime:ro
    deploy:
      replicas: 1

  dhp:
    image: registry:3.0
    container_name: dhp
    labels:
      - homepage.group=VPS
      - homepage.name=dhp
      - homepage.icon=docker-moby.svg
      - homepage.description=docker镜像registry
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - "${DATA_BASE_DIR}/dhp/data:/var/lib/registry"
    configs:
      - source: dhp_mirror_config
        target: /etc/distribution/config.yml
    environment:
      - REGISTRY_PROXY_REMOTEURL=https://registry-1.docker.io
    networks:
      - homelab
    restart: always
    deploy:
      replicas: 1

  dockerproxy:
    image: ghcr.io/tecnativa/docker-socket-proxy:v0.4.2
    container_name: dockerproxy
    restart: always
    networks:
      - homelab
    labels:
      - homepage.group=VPS
      - homepage.name=docker-proxy
      - homepage.icon=docker-moby.svg
      - homepage.description=
    environment:
      - CONTAINERS=1
      - SERVICES=1
      - TASKS=1
      - POST=0
      - VOLUMES=0
      - IMAGES=0
      - INFO=0
      - NETWORKS=0
    ports:
      - "${DOCKER_PROXY_HOST:-127.0.0.1}:2575:2375"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    deploy:
      replicas: 1

  fluent-bit:
    image: ghcr.io/fluent/fluent-bit:latest
    container_name: fluent-bit
    networks:
      - homelab
    restart: always
    environment:
      TZ: Asia/Shanghai
      VICTORIA_LOGS_HOST: ${VICTORIA_LOGS_HOST}
      VICTORIA_LOGS_PORT: ${VICTORIA_LOGS_PORT:-9428}
      HOSTNAME: vps-cc
    configs:
      - source: fluent_bit_config
        target: /fluent-bit/etc/fluent-bit.conf
      - source: fluent_bit_parsers
        target: /fluent-bit/etc/parsers.conf
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/log/caddy:/var/log/caddy:ro
      - ${DATA_BASE_DIR}/fluent-bit/db:/fluent-bit/db
    deploy:
      replicas: 1

  sub-converter:
    image: ghcr.io/shelken/subconverter:1.8.0
    container_name: sub-converter
    networks:
      - homelab
    restart: always
    labels:
      - homepage.group=VPS
      - homepage.name=订阅转换
      - homepage.icon=docker-moby.svg
      - homepage.href=https://sub.${MAIN_DOMAIN}/version
      - homepage.description=订阅转换
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    environment:
      TZ: Asia/Shanghai
      MANAGED_PREFIX: https://sub.${MAIN_DOMAIN}
      API_MODE: false
      API_TOKEN: password
    ports:
      - "127.0.0.1:25500:25500/tcp"
    deploy:
      replicas: 1

  derp:
    image: fredliang/derper:v1.94.2
    container_name: derp
    network_mode: host
    restart: always
    labels:
      - homepage.group=VPS
      - homepage.name=derp服务
      - homepage.icon=tailscale.svg
      - homepage.href=https://derp.${MAIN_DOMAIN}
      - homepage.description=derp服务
    environment:
      TZ: Asia/Shanghai
      DERP_DOMAIN: derp.${MAIN_DOMAIN}
      DERP_ADDR: ":8666"
      DERP_STUN_PORT: "3478"
      DERP_VERIFY_CLIENTS: "false"
    volumes:
      - "/var/run/tailscale/tailscaled.sock:/var/run/tailscale/tailscaled.sock"
    deploy:
      replicas: 1

  hysteria2:
    image: tobyxdd/hysteria:v2.7.1
    container_name: hysteria2
    network_mode: host
    restart: always
    labels:
      - homepage.group=VPS
      - homepage.name=hysteria2
      - homepage.icon=https://cdn.jsdelivr.net/gh/apernet/hysteria-website@master/docs/assets/logo.svg
      - homepage.description=hysteria2
    configs:
      - source: hysteria2_config
        target: /etc/hysteria/config.yaml
    volumes:
      - ${DATA_BASE_DIR}/caddy/data/caddy/certificates/acme-v02.api.letsencrypt.org-directory/wildcard_.${MAIN_DOMAIN}:/data/hysteria2/tls:ro
    command: ["server", "-c", "/etc/hysteria/config.yaml"]
    deploy:
      replicas: 1

  xray:
    image: ghcr.io/xtls/xray-core:26.2.6
    container_name: xray
    network_mode: host
    restart: always
    labels:
      - homepage.group=VPS
      - homepage.name=vless-reality
      - homepage.icon=https://avatars.githubusercontent.com/u/71564206
      - homepage.description=VLESS Reality
    configs:
      - source: xray_config
        target: /etc/xray/config.json
    command: ["run", "-config", "/etc/xray/config.json"]
    deploy:
      replicas: 1

  # ==================== OpenList ====================
  openlist:
    image: ghcr.io/openlistteam/openlist-git:v4.1.10
    container_name: openlist
    networks:
      - homelab
    restart: always
    labels:
      - homepage.group=VPS
      - homepage.name=openlist
      - homepage.icon=openlist.svg
      - homepage.href=http://${DEPLOY_HOST}:5244
      - homepage.description=网盘S3服务
    command: ./openlist server --no-prefix
    environment:
      TZ: Asia/Shanghai
      # OpenList 配置（全部使用 --no-prefix）
      S3_ENABLE: "true"
      S3_PORT: "5246"
      S3_ACCESS_KEY_ID: ${OPENLIST_S3_ACCESS_KEY_ID}
      S3_SECRET_ACCESS_KEY: ${OPENLIST_S3_SECRET_ACCESS_KEY}
      HTTP_PORT: "80"
      ADMIN_USERNAME: ${OPENLIST_ADMIN_USERNAME}
      ADMIN_PASSWORD: ${OPENLIST_ADMIN_PASSWORD}
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80/api/public/settings"]
      interval: 10s
      timeout: 1s
      retries: 10
      start_period: 30s
    volumes:
      - "${DATA_BASE_DIR}/openlist/data:/opt/openlist/data"
    ports:
      - "${DEPLOY_HOST}:5244:80/tcp"
    deploy:
      replicas: 1

  # ==================== Kopia Backup ====================
  kopia:
    image: kopia/kopia:0.22.3
    container_name: kopia
    hostname: vps
    networks:
      - homelab
    restart: always
    depends_on:
      openlist:
        condition: service_healthy
    labels:
      - homepage.group=VPS
      - homepage.name=kopia
      - homepage.icon=kopia.svg
      - homepage.href=http://${DEPLOY_HOST}:51515/tasks
      - homepage.description=备份服务
    entrypoint: ["/app/scripts/entrypoint.sh"]
    environment:
      TZ: Asia/Shanghai
      KOPIA_CONFIG_PATH: /config/repository.config
      KOPIA_CACHE_DIRECTORY: /config/cache
      KOPIA_LOG_DIR: /config/logs
      KOPIA_PASSWORD: ${KOPIA_REPO_PASSWORD}
      KOPIA_WEBHOOK_URL: ${KOPIA_WEBHOOK_URL}
      # 仅在失败/警告时通知，成功时不通知 (可选值: report, warning, error)
      KOPIA_MIN_SEVERITY: warning
    configs:
      - source: kopia_repository_config
        target: /config/repository.config
      - source: kopia_policy
        target: /config/policy.json
      - source: kopia_entrypoint
        target: /app/scripts/entrypoint.sh
    volumes:
      - kopia_cache:/config/cache
      - ${DATA_BASE_DIR}/kopia/logs:/config/logs
      - /data:/backup/data:ro
    ports:
      - "${DEPLOY_HOST}:51515:51515/tcp"
    deploy:
      replicas: 1

configs:
  caddy_config:
    file: ./configs/caddy/Caddyfile
  crowdsec_acquis_all:
    file: ./configs/crowdsec/acquis.d/all.yaml
  crowdsec_firewall_bouncer_config:
    file: ./configs/crowdsec/crowdsec-firewall-bouncer.yaml
  dhp_mirror_config:
    file: ./configs/mirror-config.yaml
  fluent_bit_config:
    file: ./configs/fluent-bit/fluent-bit.conf
  fluent_bit_parsers:
    file: ./configs/fluent-bit/parsers.conf
  kopia_repository_config:
    file: ./configs/kopia/repository.config
  kopia_policy:
    file: ./configs/kopia/policy.json
  kopia_entrypoint:
    file: ./configs/kopia/entrypoint.sh
  hysteria2_config:
    file: ./configs/hysteria2/config.yaml
  xray_config:
    file: ./configs/xray/config.json

volumes:
  kopia_cache:

networks:
  homelab:
    name: homelab
    driver: bridge
    enable_ipv6: true
    ipam:
      config:
        - subnet: 172.20.0.0/16
        - subnet: fd01:3d76:3407:1::/64
