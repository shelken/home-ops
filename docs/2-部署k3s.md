## 流程

```shell
nix shell nixpkgs#k3sup

# --embedded-registry 
# ref: https://docs.k3s.io/installation/registry-mirror?_highlight=spegel
# --k3s-version 指定版本 v1.31.9+k3s1 v1.33.1+k3s1 
# ref: https://github.com/k3s-io/k3s/releases
# --disable local-storage
# 使用openebs的localpv

# 主节点
k3sup install --user shelken --ip 192.168.6.80 \
  --k3s-extra-args "--disable traefik --disable servicelb --flannel-backend=none --disable-network-policy --disable-kube-proxy --embedded-registry --disable local-storage" \
  --k3s-version v1.33.1+k3s1 \
  --ssh-key ~/.ssh/id_ed25519

[resource/k3s/config.yaml](./resource/k3s/config.yaml)

# 加入agent（worker）
k3sup join \
    --user shelken \
    --ip 192.168.6.111 \
    --server-ip 192.168.6.80 \
    --server-user shelken \
    --k3s-version v1.33.1+k3s1 \
    --ssh-key ~/.ssh/id_ed25519

# free-network
ansible-playbook ansible/playbooks/change-k3s-proxy.yml

```

### HA 嵌入式etcd 集群

```shell 

k3sup install --user shelken --ip 192.168.6.110 --cluster \
  --k3s-extra-args "--disable traefik --disable servicelb --flannel-backend=none --disable-network-policy --disable-kube-proxy" \
  --ssh-key ~/.ssh/id_ed25519

# 加入控制平面
k3sup join \
    --user shelken \
    --ip 192.168.6.111 \
    --server-ip 192.168.6.110 \
    --server-user shelken \
    --server \
    --k3s-extra-args "--disable traefik --disable servicelb --flannel-backend=none --disable-network-policy --disable-kube-proxy" \
    --ssh-key ~/.ssh/id_ed25519

```

## 移除节点

kubectl drain <agentNodeName> --ignore-daemonsets --delete-local-data
kubectl delete node <agentNodeName>

## 卸载说明

如果需要卸载 k3s，需要在每个节点上执行以下操作：

1. 在工作节点（agent）上执行：

```shell
# 对于 agent 节点
/usr/local/bin/k3s-agent-uninstall.sh
# ansible 
ansible workers -m shell -a "sudo /usr/local/bin/k3s-agent-uninstall.sh"
ansible-playbook ansible/playbooks/delete-k3s.yml --limit=test-3
```

1. 在主节点（server）上执行：

```shell
# 对于 server 节点
/usr/local/bin/k3s-uninstall.sh
ansible control_plane -m shell -a "sudo /usr/local/bin/k3s-uninstall.sh"
ansible-playbook ansible/playbooks/delete-k3s.yml
```

注意：

- 卸载脚本会停止所有 k3s 进程
- 删除 k3s 相关的文件和目录
- 删除 iptables 规则和 ipvs 表
- 移除 k3s 创建的网络接口
