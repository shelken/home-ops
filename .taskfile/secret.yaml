---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

set: [pipefail]
shopt: [globstar]

vars:
  VAULT_NAME: shelken-homelab

tasks:
  azsecret:
    desc: 显示 {{ .VAULT_NAME }} 某个secret的value，如果没有传则显示namelist列表
    silent: true
    cmd: |
      if [ -n "{{ .key }}" ]; then
        az keyvault secret show --vault-name {{ .VAULT_NAME }} --name "{{ .key }}" --query value -otsv
        exit 0
      fi
      az keyvault secret list --vault-name {{ .VAULT_NAME }} --query "[].name"

  set-azsecret:
    desc: 向 {{ .VAULT_NAME }} 的 [key] 设置 `/tmp/secret.json` 中的值
    requires:
      vars: ["key"]
    cmd: |
      az keyvault secret set --vault-name {{ .VAULT_NAME }} --name {{ .key }} --value @'{{.file | default "/tmp/secret.json"}}'

  delete:
    desc: 删除 {{ .VAULT_NAME }} 中的某个 secret（交互式选择或指定 key=xxx）
    prompt: 确定要删除 secret "{{ .key }}" 吗？此操作不可逆！
    vars:
      key:
        sh: |
          if [ -n "{{ .key }}" ]; then
            echo "{{ .key }}"
          else
            az keyvault secret list --vault-name {{ .VAULT_NAME }} --query "[].name" -otsv | fzf --prompt="选择要删除的 secret: "
          fi
    cmd: |
      [ -z "{{ .key }}" ] && echo "未选择任何 secret" && exit 1
      az keyvault secret delete --vault-name {{ .VAULT_NAME }} --name "{{ .key }}"

  bootstrap:
    desc: 加载 bootstrap/resources.yaml 中的所有信息到集群
    cmd: |
      output=$(bash {{.ROOT_DIR}}/scripts/azure-inject.sh {{.ROOT_DIR}}/bootstrap/resources.yaml)
      echo "$output" | kubectl diff --filename - &>/dev/null \
      || echo "$output" | kubectl apply --server-side --filename -
