---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

set: [pipefail]
shopt: [globstar]

tasks:
  azsecret: 
    desc: 显示 shelken-vault 某个secret的value，如果没有传则显示namelist列表
    silent: true
    cmd: |
      if [ -n "{{ .key }}" ]; then
        az keyvault secret show --vault-name shelken-vault --name "{{ .key }}" --query value -otsv
        exit 0
      fi
      az keyvault secret list --vault-name shelken-vault --query "[].name"

  set-azsecret:
    desc: 向 shelken-vault 的 [key] 设置 `/tmp/secret.json` 中的值
    requires:
      vars: ["key"]
    cmd: |
      az keyvault secret set --vault-name shelken-vault --name {{ .key }} --value @/tmp/secret.json

  bootstrap:
    desc: 加载 bootstrap/resources.yaml 中的所有信息到集群
    cmd: |
      output=$(bash {{.ROOT_DIR}}/scripts/azure-inject.sh {{.ROOT_DIR}}/bootstrap/resources.yaml)
      echo "$output" | kubectl diff --filename - &>/dev/null \
      || echo "$output" | kubectl apply --server-side --filename -

  deploy-azure-creds:
    desc: "【废弃|使用bootstrap】部署 azure 的验证信息让 external-secrets 访问我们的 KeyVault"
    silent: false
    preconditions:
      - '[ -n "$ClientID" ]'
      - '[ -n "$ClientSecret" ]'
    cmd: |
      kubectl get namespace external-secrets >/dev/null 2>&1 || kubectl create namespace external-secrets
      kubectl create secret -n external-secrets generic azure-creds \
      --from-literal=ClientID={{ .ClientID }} \
      --from-literal=ClientSecret={{ .ClientSecret }} --dry-run=client -o yaml \
      | kubectl apply -f -

  deploy-secret:
    desc: "【废弃|使用bootstrap】部署sops加密的Secret让flux kustomization能够解密"
    cmd: |
      kubectl get namespace flux-system >/dev/null 2>&1 || kubectl create namespace flux-system
      sops exec-file "{{.ROOT_DIR}}/k8s/components/common/sops/secret.sops.yaml" "kubectl --namespace flux-system apply --server-side --filename {}"
