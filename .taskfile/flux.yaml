---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

set: [pipefail]
shopt: [globstar]

tasks:
  restart-failed-releases:
    silent: true
    desc: "Suspend and resume all HelmReleases with ready=false"
    cmds:
      - |
        echo "ğŸ” Finding HelmReleases with ready=false..."

        # è·å–æ‰€æœ‰ ready=false çš„ HelmReleases
        FAILED_RELEASES=$(kubectl get helmreleases -A -o json | \
          jq -r '.items[] | select(.status.conditions[]? | select(.type=="Ready" and .status=="False")) | "\(.metadata.namespace)/\(.metadata.name)"')

        if [ -z "$FAILED_RELEASES" ]; then
          echo "âœ… No failed HelmReleases found"
          exit 0
        fi

        echo "Found failed HelmReleases:"
        echo "$FAILED_RELEASES"
        echo ""

        # å¤„ç†æ¯ä¸ªå¤±è´¥çš„ release
        echo "$FAILED_RELEASES" | while IFS= read -r release; do
          if [ -n "$release" ]; then
            NAMESPACE=$(echo "$release" | cut -d'/' -f1)
            NAME=$(echo "$release" | cut -d'/' -f2)

            echo "ğŸ”„ Processing $NAME in namespace $NAMESPACE..."

            # Suspend
            echo "  â¸ï¸  Suspending..."
            flux suspend helmrelease "$NAME" -n "$NAMESPACE"

            # ç­‰å¾…ä¸€ä¸‹
            sleep 2

            # Resume
            echo "  â–¶ï¸  Resuming..."
            flux resume helmrelease "$NAME" -n "$NAMESPACE"

            echo "  âœ… Done"
            echo ""
          fi
        done

        echo "ğŸ‰ All failed HelmReleases have been restarted"

  list-failed-releases:
    silent: true
    desc: "List all HelmReleases with ready=false"
    cmds:
      - |
        echo "ğŸ” HelmReleases with ready=false:"
        kubectl get helmreleases -A -o json | \
          jq -r '.items[] | select(.status.conditions[]? | select(.type=="Ready" and .status=="False")) | "\(.metadata.namespace)/\(.metadata.name): \(.status.conditions[] | select(.type=="Ready") | .message)"' | \
          column -t -s ":"

  restart-specific-release:
    silent: true
    desc: "Suspend and resume a specific HelmRelease"
    vars:
      NAME: '{{.NAME | default ""}}'
      NAMESPACE: '{{.NAMESPACE | default "flux-system"}}'
    preconditions:
      - sh: '[ -n "{{.NAME}}" ]'
        msg: "Please provide NAME variable: task restart-specific-release NAME=cilium NAMESPACE=kube-system"
    cmds:
      - echo "ğŸ”„ Restarting HelmRelease {{.NAME}} in namespace {{.NAMESPACE}}..."
      - flux suspend helmrelease {{.NAME}} -n {{.NAMESPACE}}
      - sleep 2
      - flux resume helmrelease {{.NAME}} -n {{.NAMESPACE}}
      - echo "âœ… Done"

  force-reconcile-failed:
    silent: true
    desc: "Force reconcile all failed HelmReleases"
    cmds:
      - |
        echo "ğŸ”„ Force reconciling failed HelmReleases..."

        kubectl get helmreleases -A -o json | \
          jq -r '.items[] | select(.status.conditions[]? | select(.type=="Ready" and .status=="False")) | "\(.metadata.namespace) \(.metadata.name)"' | \
          while read -r namespace name; do
            if [ -n "$namespace" ] && [ -n "$name" ]; then
              echo "  ğŸ”„ Reconciling $name in $namespace..."
              flux reconcile helmrelease "$name" -n "$namespace"
            fi
          done

        echo "âœ… All failed releases reconciled"
