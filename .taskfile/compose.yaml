---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

vars:
  COMPOSE_DIR: "{{.ROOT_DIR}}/compose"
  SCRIPTS_DIR: "{{.ROOT_DIR}}/scripts"

  # sakamoto 配置
  SAKAMOTO_HOST: "sakamoto.lan"
  SAKAMOTO_COMPOSE_DIR: "~/homelab-compose"

  # VPS 配置
  VPS_HOST: "vps-cc"
  VPS_COMPOSE_DIR: "/opt/homelab-compose"

tasks:
  # ==================== sakamoto ====================
  deploy:sakamoto:
    desc: "部署到 sakamoto"
    cmds:
      - task: :compose:_deploy
        vars:
          HOST: "{{.SAKAMOTO_HOST}}"
          REMOTE_DIR: "{{.SAKAMOTO_COMPOSE_DIR}}"
          LOCAL_DIR: "{{.COMPOSE_DIR}}/sakamoto"

  sync:sakamoto:
    desc: "仅同步配置到 sakamoto（不重启服务）"
    cmds:
      - task: :compose:_sync
        vars:
          HOST: "{{.SAKAMOTO_HOST}}"
          REMOTE_DIR: "{{.SAKAMOTO_COMPOSE_DIR}}"
          LOCAL_DIR: "{{.COMPOSE_DIR}}/sakamoto"

  status:sakamoto:
    desc: "查看 sakamoto 服务状态"
    cmd: ssh {{.SAKAMOTO_HOST}} "cd {{.SAKAMOTO_COMPOSE_DIR}} && docker compose ps"

  logs:sakamoto:
    desc: "查看 sakamoto 服务日志"
    cmd: ssh {{.SAKAMOTO_HOST}} "cd {{.SAKAMOTO_COMPOSE_DIR}} && docker compose logs -f --tail=100"

  kopia-init:sakamoto:
    desc: "初始化 sakamoto 的 Kopia 仓库和策略"
    cmds:
      - |
        ssh {{.SAKAMOTO_HOST}} "cd {{.SAKAMOTO_COMPOSE_DIR}} && \
          docker exec kopia kopia repository connect from-config --file /app/config/repository.config || \
          docker exec kopia kopia repository create from-config --file /app/config/repository.config"
      - |
        ssh {{.SAKAMOTO_HOST}} "cd {{.SAKAMOTO_COMPOSE_DIR}} && \
          docker exec kopia kopia policy import --from-file /app/config/policy.json"

  # ==================== VPS ====================
  deploy:vps:
    desc: "部署到 VPS"
    cmds:
      - task: :compose:_deploy
        vars:
          HOST: "{{.VPS_HOST}}"
          REMOTE_DIR: "{{.VPS_COMPOSE_DIR}}"
          LOCAL_DIR: "{{.COMPOSE_DIR}}/vps"

  sync:vps:
    desc: "仅同步配置到 VPS（不重启服务）"
    cmds:
      - task: :compose:_sync
        vars:
          HOST: "{{.VPS_HOST}}"
          REMOTE_DIR: "{{.VPS_COMPOSE_DIR}}"
          LOCAL_DIR: "{{.COMPOSE_DIR}}/vps"

  status:vps:
    desc: "查看 VPS 服务状态"
    cmd: ssh {{.VPS_HOST}} "cd {{.VPS_COMPOSE_DIR}} && docker compose ps"

  logs:vps:
    desc: "查看 VPS 服务日志"
    cmd: ssh {{.VPS_HOST}} "cd {{.VPS_COMPOSE_DIR}} && docker compose logs -f --tail=100"

  kopia-init:vps:
    desc: "初始化 VPS 的 Kopia 仓库和策略"
    cmds:
      - |
        ssh {{.VPS_HOST}} "cd {{.VPS_COMPOSE_DIR}} && \
          docker exec kopia kopia repository connect from-config --file /app/config/repository.config || \
          docker exec kopia kopia repository create from-config --file /app/config/repository.config"
      - |
        ssh {{.VPS_HOST}} "cd {{.VPS_COMPOSE_DIR}} && \
          docker exec kopia kopia policy import --from-file /app/config/policy.json"

  # ==================== 内部任务 ====================
  _deploy:
    internal: true
    requires:
      vars: [HOST, REMOTE_DIR, LOCAL_DIR]
    cmds:
      - task: :compose:_sync
        vars:
          HOST: "{{.HOST}}"
          REMOTE_DIR: "{{.REMOTE_DIR}}"
          LOCAL_DIR: "{{.LOCAL_DIR}}"
      - |
        ssh {{.HOST}} "cd {{.REMOTE_DIR}} && docker compose pull && docker compose up -d"

  _sync:
    internal: true
    requires:
      vars: [HOST, REMOTE_DIR, LOCAL_DIR]
    cmds:
      # 1. 渲染 .env.tpl → .env
      - |
        {{.SCRIPTS_DIR}}/azure-inject.sh "{{.LOCAL_DIR}}/.env.tpl" > "{{.LOCAL_DIR}}/.env"
        chmod 400 "{{.LOCAL_DIR}}/.env"
      # 2. 渲染 kopia/repository.config.tpl → kopia/repository.config
      - |
        if [ -f "{{.LOCAL_DIR}}/kopia/repository.config.tpl" ]; then
          {{.SCRIPTS_DIR}}/azure-inject.sh "{{.LOCAL_DIR}}/kopia/repository.config.tpl" > "{{.LOCAL_DIR}}/kopia/repository.config"
        fi
      # 3. 同步文件到目标机器（文件自动属于 SSH 登录用户）
      - |
        rsync -avz --delete --no-owner --no-group \
          --exclude '.env.tpl' \
          --exclude 'repository.config.tpl' \
          "{{.LOCAL_DIR}}/" "{{.HOST}}:{{.REMOTE_DIR}}/"
      # 4. 清理本地生成的敏感文件
      - defer: rm -f "{{.LOCAL_DIR}}/.env" "{{.LOCAL_DIR}}/kopia/repository.config"
