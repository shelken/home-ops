---
- name: 准备 Kubernetes 节点
  hosts: all
  become: true
  tasks:
    - name: 设置主机名为 "{{ inventory_hostname }}"
      ansible.builtin.hostname:
        name: "{{ inventory_hostname }}"
    - name: 设置时区
      community.general.timezone:
        name: "{{ system_timezone }}"
    - name: install pkgs
      ansible.builtin.apt:
        name: "{{ system_packages }}"
        state: present      
        # update_cache: yes

    - name: 安装 intel gpu 所需包
      ansible.builtin.apt:
        name: "{{ item }}"
        state: present
        install_recommends: no
        force_apt_get: yes
        allow_unauthenticated: no
      loop: 
        - linux-modules-extra-{{ ansible_kernel }}
        - linux-firmware
        - fonts-noto-cjk # jellyfin 中文字体
      when: 
        - (intel_gpu | default(false)) | bool

    - import_tasks: playbooks/tasks/qemu-guest-agent.yaml
      when:
        - ansible_facts.virtualization_type == "kvm"
        - ansible_facts.virtualization_role == "guest"

# - import_playbook: playbooks/install-nvidia.yaml

    # - name: 配置 sysctl 参数
    #   sysctl:
    #     name: "{{ item.key }}"
    #     value: "{{ item.value }}"
    #     state: present
    #     reload: yes
    #   with_dict: "{{ sysctl_config }}"

# - name: 配置控制平面节点
#   hosts: controllers
#   become: true
#   tasks:
#     - name: 设置主机名
#       hostname:
#         name: "{{ inventory_hostname }}"

# - name: 配置工作节点
#   hosts: workers
#   become: true
#   tasks:
#     - name: 设置主机名
#       hostname:
#         name: "{{ inventory_hostname }}"
