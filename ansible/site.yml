---
- name: 准备 Kubernetes 节点
  hosts: all
  become: true
  tasks:
    - name: 设置主机名为 "{{ inventory_hostname }}"
      ansible.builtin.hostname:
        name: "{{ inventory_hostname }}"
    - name: 设置时区
      community.general.timezone:
        name: "{{ system_timezone }}"

    # - name: 下载换源脚本
    #   ansible.builtin.get_url:
    #     # url: https://linuxmirrors.cn/main.sh
    #     url: https://raw.githubusercontent.com/SuperManito/LinuxMirrors/refs/heads/main/ChangeMirrors.sh
    #     dest: /tmp/linuxmirrors.sh
    #     mode: "0755"
    # - name: 换源
    #   ansible.builtin.command: |
    #     bash /tmp/linuxmirrors.sh \
    #       --source mirrors.ustc.edu.cn \
    #       --protocol http \
    #       --use-intranet-source false \
    #       --backup true \
    #       --upgrade-software false \
    #       --clean-cache false \
    #       --ignore-backup-tips \
    #       --pure-mode

    - name: install system pkgs
      ansible.builtin.apt:
        name: "{{ system_packages }}"
        state: present
        # update_cache: yes

    - import_tasks: playbooks/tasks/cifs.yaml

    - name: 配置 Intel GPU 驱动
      block:
        - name: 安装 intel gpu 所需包
          ansible.builtin.apt:
            name: "{{ item }}"
            state: present
            install_recommends: no
            force_apt_get: yes
            allow_unauthenticated: no
          loop:
            - linux-modules-extra-{{ ansible_kernel }}
            - linux-firmware
            # - fonts-noto-cjk # jellyfin 3.11.1已经内置

        - name: 检查 i915 模块是否已加载
          shell: lsmod | grep -q i915
          register: i915_loaded
          changed_when: false
          failed_when: false

        - name: 加载 i915 内核模块
          community.general.modprobe:
            name: i915
            state: present
          when: i915_loaded.rc != 0

        - name: 设置 i915 模块开机自动加载
          lineinfile:
            path: /etc/modules
            line: i915
            create: yes
            state: present
          register: modules_changed

        - name: 更新 initramfs
          command: update-initramfs -u
          when: modules_changed.changed
          register: initramfs_result
          changed_when: "'done.' in initramfs_result.stdout"
      when:
        - (intel_gpu | default(false)) | bool

    - import_tasks: playbooks/tasks/qemu-guest-agent.yaml
      when:
        - ansible_facts.virtualization_type == "kvm"
        - ansible_facts.virtualization_role == "guest"
# - import_playbook: playbooks/install-nvidia.yaml

# - name: 配置 sysctl 参数
#   sysctl:
#     name: "{{ item.key }}"
#     value: "{{ item.value }}"
#     state: present
#     reload: yes
#   with_dict: "{{ sysctl_config }}"

# - name: 配置控制平面节点
#   hosts: controllers
#   become: true
#   tasks:
#     - name: 设置主机名
#       hostname:
#         name: "{{ inventory_hostname }}"

# - name: 配置工作节点
#   hosts: workers
#   become: true
#   tasks:
#     - name: 设置主机名
#       hostname:
#         name: "{{ inventory_hostname }}"
