---
- name: 准备 Kubernetes 节点
  hosts: all
  become: true
  tasks:
    - name: 设置主机名为 "{{ inventory_hostname }}"
      ansible.builtin.hostname:
        name: "{{ inventory_hostname }}"
    - name: 设置时区
      community.general.timezone:
        name: "{{ system_timezone }}"

    - import_tasks: playbooks/tasks/ntp.yaml

    - import_tasks: playbooks/tasks/dns-patch.yaml

    - import_tasks: playbooks/tasks/change-sources.yaml

    - name: install system pkgs
      ansible.builtin.apt:
        name: "{{ system_packages }}"
        state: present
        # update_cache: yes

    - import_tasks: playbooks/tasks/cifs.yaml

    - import_tasks: playbooks/tasks/install-intel.yaml

    - import_tasks: playbooks/tasks/qemu-guest-agent.yaml
      when:
        - ansible_facts.virtualization_type == "kvm"
        - ansible_facts.virtualization_role == "guest"

  handlers:
    - name: restart chrony
      ansible.builtin.service:
        name: chrony
        state: restarted

# - import_playbook: playbooks/install-nvidia.yaml

# - name: 配置 sysctl 参数
#   sysctl:
#     name: "{{ item.key }}"
#     value: "{{ item.value }}"
#     state: present
#     reload: yes
#   with_dict: "{{ sysctl_config }}"

# - name: 配置控制平面节点
#   hosts: controllers
#   become: true
#   tasks:
#     - name: 设置主机名
#       hostname:
#         name: "{{ inventory_hostname }}"

# - name: 配置工作节点
#   hosts: workers
#   become: true
#   tasks:
#     - name: 设置主机名
#       hostname:
#         name: "{{ inventory_hostname }}"
