---
- name: 传递资源
  hosts: all
  become:
    true
    # vars:
    #   k3s_proxy_ip: "192.168.6.248"
    #   k3s_proxy_port: "7890"
    #   delete_proxy: false
  tasks:
    - name: 创建 k3s 配置目录
      ansible.builtin.file:
        path: /etc/rancher/k3s
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: 复制本地文件到远程并强制覆盖
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/resource/{{ item }}"
        dest: /etc/rancher/k3s/{{ item }}
        owner: root
        group: root
        mode: "0600"
        force: true
      loop:
        # - config.yaml
        - registries.yaml
    - name: 检查 k3s 服务是否存在
      ansible.builtin.systemd:
        name: "{{ 'k3s' if k3s_control_node == 'true' else 'k3s-agent' }}"
      register: k3s_service_check
      failed_when: false
      changed_when: false
    - name: 重启k3s
      ansible.builtin.service:
        name: "{{ 'k3s' if k3s_control_node == 'true' else 'k3s-agent' }}"
        state: restarted
      when: k3s_service_check.status.LoadState != "not-found"
