---
- name: Check if chrony is installed
  ansible.builtin.shell: dpkg -l chrony 2>/dev/null | grep -q "^ii"
  register: chrony_installed
  changed_when: false
  failed_when: false

- name: Install chrony
  ansible.builtin.apt:
    name: chrony
    state: present
  when: chrony_installed.rc != 0

- name: Configure chrony with Aliyun NTP servers
  ansible.builtin.blockinfile:
    path: /etc/chrony/chrony.conf
    marker: "# {mark} ANSIBLE MANAGED BLOCK: ALIYUN NTP"
    block: |
      server ntp.aliyun.com iburst
      server ntp1.aliyun.com iburst
    backup: yes
  notify: restart chrony

- name: Ensure chrony is enabled and started
  ansible.builtin.service:
    name: chrony
    state: started
    enabled: yes

- name: Check if systemd-timesyncd exists
  ansible.builtin.shell: systemctl list-unit-files | grep -q systemd-timesyncd
  register: timesyncd_exists
  changed_when: false
  failed_when: false

- name: Disable and stop systemd-timesyncd
  ansible.builtin.service:
    name: systemd-timesyncd
    state: stopped
    enabled: no
  when: timesyncd_exists.rc == 0
