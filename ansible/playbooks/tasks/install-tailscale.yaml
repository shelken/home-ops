---
- name: 检查是否需要安装 Tailscale
  ansible.builtin.set_fact:
    should_install_tailscale: "{{ enable_install_tailscale | default(false) | bool }}"

- name: 检查 Tailscale 是否已安装
  ansible.builtin.command: tailscale --version
  register: tailscale_check
  failed_when: false
  changed_when: false
  when: should_install_tailscale

- name: 安装 Tailscale (使用官方脚本)
  ansible.builtin.shell: |
    curl -fsSL https://tailscale.com/install.sh -o install-tailscale.sh
    sh install-tailscale.sh
    rm install-tailscale.sh
  args:
    creates: /usr/bin/tailscale
  when:
    - should_install_tailscale
    - tailscale_check.rc != 0
