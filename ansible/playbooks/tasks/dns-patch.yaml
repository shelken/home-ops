---
- name: 实施全局 DNS 纯净策略
  block:
    # -------------------------------------------------------
    # 第一步：配置全局统一的 DNS 服务器 IP
    # 这是一个真正的全局配置，位于 /etc/systemd/resolved.conf
    # -------------------------------------------------------
    - name: 配置 systemd-resolved 全局 DNS
      ansible.builtin.lineinfile:
        path: /etc/systemd/resolved.conf
        regexp: '^#?DNS='
        # 这里填你固定的 DNS
        line: "DNS={{ dns_servers | default(['223.5.5.5', '192.168.6.1']) | join(' ') }}"
        state: present
      notify: Restart systemd-resolved

    # -------------------------------------------------------
    # 第二步：检测网络管理器类型
    # -------------------------------------------------------
    - name: 检查 NetworkManager 是否在运行
      ansible.builtin.command: systemctl is-active NetworkManager
      register: nm_status
      changed_when: false
      failed_when: false

    - name: 检查 systemd-networkd 是否在运行
      ansible.builtin.command: systemctl is-active systemd-networkd
      register: networkd_status
      changed_when: false
      failed_when: false

    # -------------------------------------------------------
    # 第三步 (A)：NetworkManager 环境 - 配置忽略 DHCP DNS
    # -------------------------------------------------------
    - name: 创建 NetworkManager DNS 配置目录
      ansible.builtin.file:
        path: /etc/NetworkManager/conf.d
        state: directory
        mode: '0755'
      when: nm_status.rc == 0

    - name: 配置 NetworkManager 使用 systemd-resolved 并忽略 DHCP DNS
      ansible.builtin.copy:
        dest: /etc/NetworkManager/conf.d/90-dns-systemd-resolved.conf
        content: |
          # Ansible Managed: 使用 systemd-resolved 作为 DNS 后端
          # 忽略 DHCP 提供的 DNS，使用全局配置
          [main]
          dns=systemd-resolved

          [connection]
          ipv4.ignore-auto-dns=true
          ipv6.ignore-auto-dns=true
        mode: '0644'
      when: nm_status.rc == 0
      notify: Reload NetworkManager

    # -------------------------------------------------------
    # 第三步 (B)：systemd-networkd 环境 - 屏蔽 Netplan 上游 DNS
    # -------------------------------------------------------
    - name: 发现所有 Netplan 生成的网卡配置
      ansible.builtin.find:
        paths: /run/systemd/network
        patterns: "*netplan*.network" # 自动匹配所有 Netplan 网卡，无需人工指定
      register: target_interfaces
      when: networkd_status.rc == 0

    - name: 为所有网卡创建补丁目录
      ansible.builtin.file:
        path: "/etc/systemd/network/{{ item.path | basename }}.d"
        state: directory
        mode: '0755'
      loop: "{{ target_interfaces.files | default([]) }}"
      loop_control:
        label: "{{ item.path | basename }}"
      when: networkd_status.rc == 0 and target_interfaces.files | default([]) | length > 0

    - name: 下发屏蔽策略 (禁止接收上游 DNS)
      ansible.builtin.copy:
        dest: "/etc/systemd/network/{{ item.path | basename }}.d/override-block-upstream-dns.conf"
        content: |
          # Ansible Managed: Block Upstream DNS
          # 仅屏蔽 DNS 获取，不影响 Netplan 的 IP/路由配置

          [Network]
          # 确保优先使用全局 resolved.conf 的 DNS
          DNSDefaultRoute=true

          [IPv6AcceptRA]
          UseDNS=false
          UseDomains=false

          [DHCPv4]
          UseDNS=false

          [DHCPv6]
          UseDNS=false
        mode: '0644'
      loop: "{{ target_interfaces.files | default([]) }}"
      loop_control:
        label: "{{ item.path | basename }}"
      when: networkd_status.rc == 0 and target_interfaces.files | default([]) | length > 0
      notify: Reload systemd-networkd
